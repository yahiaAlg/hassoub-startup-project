{% extends "base.html" %}
{% load static %}

{% block title %}{{ lesson.title }}{% endblock title %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/lessons/lesson.css' %}" />
{% endblock extra_css %}

{% block content %}
<div class="lesson-container fade-in">
  <!-- Lesson Header -->
  <div class="lesson-header">
    <div class="lesson-title">{{ lesson.icon }} {{ lesson.title }}</div>
    <div class="lesson-subtitle">{{ lesson.description }}</div>
    <div class="lesson-meta">
      <div class="meta-item">
        <span class="meta-icon">ğŸ“Š</span>
        <span>{{ lesson.path.get_difficulty_display }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-icon">ğŸ‘¶</span>
        <span>Ø§Ù„Ø£Ø¹Ù…Ø§Ø± {{ lesson.path.min_age }}-{{ lesson.path.max_age }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-icon">â±ï¸</span>
        <span>{{ lesson.duration }} Ø¯Ù‚ÙŠÙ‚Ø©</span>
      </div>
      <div class="meta-item">
        <span class="meta-icon">ğŸ…</span>
        <span>{{ lesson.points }} Ù†Ù‚Ø·Ø© â€¢ {{ lesson.coins }} Ø¹Ù…Ù„Ø©</span>
      </div>
    </div>
  </div>

  <!-- Lesson Content -->
  <div class="lesson-content">
    <!-- Progress Tracker -->
    <div class="progress-tracker">
      <div>
        <div class="progress-label">ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø³:</div>
        <div class="progress-percentage">{{ user_lesson.progress_percentage|default:0 }}% Ù…ÙƒØªÙ…Ù„</div>
      </div>
      <div class="progress-steps">
        {% for i in "1234" %}
        <div class="progress-step {% if forloop.counter <= user_lesson.progress_percentage|default:0|divisibleby:25 %}completed{% elif forloop.counter == user_lesson.progress_percentage|default:0|add:25|divisibleby:25 %}active{% endif %}">
          {{ forloop.counter }}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Lesson Content from Database -->
    <div class="section">
      {{ lesson.content|safe }}
    </div>

    <!-- Video Section (if available) -->
    {% if lesson.video_url %}
    <div class="section">
      <h2 class="section-title">
        <span class="section-icon">ğŸ¥</span>
        ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¯Ø±Ø³
      </h2>
      <div class="content-box">
        <div class="video-container">
          <iframe src="{{ lesson.video_url }}" 
                  frameborder="0" 
                  allowfullscreen
                  style="width: 100%; height: 400px; border-radius: 10px;"></iframe>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Quiz Section -->
    {% if quiz %}
    <div class="section">
      <h2 class="section-title">
        <span class="section-icon">â“</span>
        {{ quiz.title }}
      </h2>
      <p>{{ quiz.description }}</p>

      <form method="post" action="{% url 'lessons:quiz_submit' quiz.id %}" id="quizForm">
        {% csrf_token %}
        
        {% for question in quiz.questions.all %}
        <div class="quiz-question">
          <div class="question-number">Ø§Ù„Ø³Ø¤Ø§Ù„ {{ forloop.counter }} Ù…Ù† {{ quiz.questions.count }}</div>
          <div class="question-text">{{ question.question_text }}</div>
          
          {% if question.question_type == 'multiple' %}
          <div class="options-grid">
            {% for answer in question.answers.all %}
            <div class="option" onclick="selectOption(this, 'question_{{ question.id }}', '{{ answer.id }}')">
              {{ answer.answer_text }}
            </div>
            {% endfor %}
          </div>
          <input type="hidden" name="question_{{ question.id }}" id="question_{{ question.id }}_input">
          
          {% elif question.question_type == 'true_false' %}
          <div class="options-grid">
            {% for answer in question.answers.all %}
            <div class="option" onclick="selectOption(this, 'question_{{ question.id }}', '{{ answer.id }}')">
              {{ answer.answer_text }}
            </div>
            {% endfor %}
          </div>
          <input type="hidden" name="question_{{ question.id }}" id="question_{{ question.id }}_input">
          
          {% elif question.question_type == 'text' %}
          <textarea name="question_{{ question.id }}" 
                    class="input-field" 
                    rows="3" 
                    placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..."
                    style="width: 100%; padding: 10px; border-radius: 5px;"></textarea>
          {% endif %}
        </div>
        {% endfor %}

        <div style="text-align: center; margin-top: 25px">
          <button type="submit" class="button">
            ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
          </button>
        </div>
      </form>

      <div id="quiz-feedback" class="feedback"></div>
    </div>
    {% endif %}

    <!-- Completion Badge -->
    {% if user_lesson.is_completed %}
    <div id="completion-badge" class="completion-badge show">
      <div class="badge-icon">ğŸ…</div>
      <div class="badge-title">Ù…Ø¨Ø±ÙˆÙƒ! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø¯Ø±Ø³</div>
      <div class="badge-description">Ø­ØµÙ„Øª Ø¹Ù„Ù‰ {{ lesson.points }} Ù†Ù‚Ø·Ø© Ùˆ {{ lesson.coins }} Ø¹Ù…Ù„Ø©!</div>
      <a href="{% url 'lessons:learning_path' %}" class="button">
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„ØªØ¹Ù„Ù…
      </a>
    </div>
    {% else %}
    <div id="completion-badge" class="completion-badge">
      <div class="badge-icon">ğŸ…</div>
      <div class="badge-title">Ø®Ø¨ÙŠØ± Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©!</div>
      <div class="badge-description">Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¯Ø±Ø³ {{ lesson.title }}!</div>
      <a href="{% url 'lessons:learning_path' %}" class="button">
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </a>
    </div>
    {% endif %}

    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
      <a href="{% url 'lessons:learning_path' %}" class="button secondary">
        â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„ØªØ¹Ù„Ù…
      </a>
      
      {% if not user_lesson.is_completed %}
      <form method="post" action="{% url 'lessons:complete_lesson' lesson.id %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="button" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙƒÙ…Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ')">
          ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…ÙƒØªÙ…Ù„ â†’
        </button>
      </form>
      {% else %}
      <span class="button" style="background: #4caf50; cursor: default;">
        âœ“ Ù…ÙƒØªÙ…Ù„
      </span>
      {% endif %}
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
  // Django context data
  const lessonData = {
    id: {{ lesson.id }},
    title: "{{ lesson.title|escapejs }}",
    isCompleted: {{ user_lesson.is_completed|yesno:"true,false" }},
    progress: {{ user_lesson.progress_percentage|default:0 }}
  };

  const quizData = {% if quiz %}{
    id: {{ quiz.id }},
    passPercentage: {{ quiz.pass_percentage }},
    questionCount: {{ quiz.questions.count }}
  }{% else %}null{% endif %};

  // Quiz option selection
  function selectOption(element, questionName, answerId) {
    const options = element.parentElement.querySelectorAll('.option');
    options.forEach(opt => opt.classList.remove('selected'));
    element.classList.add('selected');
    
    // Set hidden input value
    const input = document.getElementById(questionName + '_input');
    if (input) {
      input.value = answerId;
    }
  }

  // Update progress display
  function updateProgress(percentage) {
    document.querySelector('.progress-percentage').textContent = percentage + '% Ù…ÙƒØªÙ…Ù„';
    
    const steps = document.querySelectorAll('.progress-step');
    const completedSteps = Math.floor((percentage / 100) * steps.length);
    
    steps.forEach((step, index) => {
      if (index < completedSteps) {
        step.classList.add('completed');
        step.classList.remove('active');
      } else if (index === completedSteps) {
        step.classList.add('active');
        step.classList.remove('completed');
      } else {
        step.classList.remove('completed', 'active');
      }
    });
  }

  // Show completion badge
  function showCompletionBadge() {
    const badge = document.getElementById('completion-badge');
    badge.classList.add('show');
    badge.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Form validation before submit
  {% if quiz %}
  document.getElementById('quizForm').addEventListener('submit', function(e) {
    const hiddenInputs = document.querySelectorAll('input[type="hidden"][name^="question_"]');
    let allAnswered = true;
    
    hiddenInputs.forEach(input => {
      if (!input.value) {
        allAnswered = false;
      }
    });
    
    if (!allAnswered) {
      e.preventDefault();
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!');
      return false;
    }
  });
  {% endif %}

  // Smooth scroll for internal links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });

  // Auto-save progress (placeholder for future AJAX implementation)
  function autoSaveProgress() {
    const progress = lessonData.progress;
    console.log('Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', progress + '%');
    // Future: Send AJAX request to save progress
  }

  // Initialize on page load
  window.addEventListener('load', function() {
    console.log('%c Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ' + lessonData.title + '! ğŸ’°', 
      'color: #4caf50; font-size: 20px; font-weight: bold;');
    
    // Show completion badge if lesson is completed
    if (lessonData.isCompleted) {
      setTimeout(showCompletionBadge, 500);
    }
    
    // Set up auto-save interval (every minute)
    setInterval(autoSaveProgress, 60000);
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Esc key to go back
    if (e.key === 'Escape') {
      window.location.href = "{% url 'lessons:learning_path' %}";
    }
  });
</script>
{% endblock extra_js %}