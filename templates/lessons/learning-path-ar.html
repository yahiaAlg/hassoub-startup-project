{% extends "base.html" %}
{% load static %}

{% block title %}{{ path.title }}{% endblock title %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/lessons/learning-path.css' %}" />
{% endblock extra_css %}

{% block content %}
    <!-- Path Container -->
    <div class="path-container">
      <!-- Path Header -->
      <div class="path-header">
        <h1 class="path-title">{{ path.icon }} {{ path.title }}</h1>
        <p class="path-description">{{ path.description }}</p>
        <div class="path-meta">
          <div class="meta-item">
            <span class="meta-icon">ğŸ“Š</span>
            {{ path.get_difficulty_display }}
          </div>
          <div class="meta-item">
            <span class="meta-icon">ğŸ‘¶</span>
            Ø§Ù„Ø£Ø¹Ù…Ø§Ø± {{ path.min_age }}-{{ path.max_age }}
          </div>
          <div class="meta-item">
            <span class="meta-icon">â±ï¸</span>
            ~{{ path.total_duration|floatformat:0 }} Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ø¬Ù…Ø§Ù„Ø§Ù‹
          </div>
          {% if path.certificate_available %}
          <div class="meta-item">
            <span class="meta-icon">ğŸ“</span>
            Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…ØªØ§Ø­Ø©
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Progress Container -->
      <div class="progress-container">
        <h2 class="progress-title">ØªÙ‚Ø¯Ù…Ùƒ</h2>
        <div class="overall-progress">
          <span class="progress-text">{{ progress_percentage }}% Ù…ÙƒØªÙ…Ù„</span>
          <div class="progress-bar">
            <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
          </div>
          <span class="progress-stats">{{ completed_lessons }}/{{ total_lessons }} Ø¯Ø±Ø³</span>
        </div>
      </div>

      <!-- Lessons Container -->
      <div class="lessons-container">
        {% for lesson_data in lessons_data %}
        <div class="lesson-card {{ lesson_data.status }}" 
             {% if not lesson_data.is_locked %}
             onclick="window.location.href='{% url 'lessons:lesson_detail' lesson_data.lesson.id %}'"
             {% else %}
             onclick="showLockedMessage()"
             {% endif %}
             style="cursor: pointer;">
          <div class="lesson-icon {{ lesson_data.status }}">{{ lesson_data.lesson.icon }}</div>
          <div class="lesson-content">
            <h3 class="lesson-title">{{ lesson_data.lesson.title }}</h3>
            <p class="lesson-description">{{ lesson_data.lesson.description }}</p>
            <div class="lesson-meta">
              <span class="lesson-duration">{{ lesson_data.lesson.duration }} Ø¯Ù‚ÙŠÙ‚Ø©</span>
              <span class="lesson-status status-{{ lesson_data.status }}">
                {% if lesson_data.status == 'completed' %}
                  <span class="checkmark">âœ“</span>
                  Ù…ÙƒØªÙ…Ù„
                {% elif lesson_data.status == 'inprogress' %}
                  <span class="progress">â³</span>
                  Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…
                {% elif lesson_data.status == 'locked' %}
                  <span class="lock">ğŸ”’</span>
                  Ù…Ù‚ÙÙ„
                {% else %}
                  <span class="unlock">ğŸ”“</span>
                  ØºÙŠØ± Ù…Ù‚ÙÙ„
                {% endif %}
              </span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Path Navigation -->
      <div class="path-navigation">
        <button class="nav-button prev" onclick="goBack()">
          â† Ø§Ù„Ø¹ÙˆØ¯Ø©
        </button>
        {% if progress_percentage < 100 %}
        <button class="nav-button next" onclick="continueCurrentLesson()">
          Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¹Ù„Ù… â†’
        </button>
        {% endif %}
      </div>

      <!-- Path Completion -->
      {% if progress_percentage == 100 %}
      <div class="path-completion" id="completionSection">
        <div class="completion-icon">ğŸ‰</div>
        <h2 class="completion-message">ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª {{ path.title }}!</h2>
        <p class="completion-subtitle">
          Ù„Ù‚Ø¯ Ø£ØªÙ‚Ù†Øª Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©. Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ù‡Ø§Ø¯ØªÙƒ Ø§Ù„Ø¢Ù†!
        </p>
        <form method="post" action="{% url 'lessons:generate_certificate' path.id %}">
          {% csrf_token %}
          <button type="submit" class="certificate-button">
            ğŸ“ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ù‡Ø§Ø¯ØªÙƒ
          </button>
        </form>
      </div>
      {% endif %}
    </div>

    <!-- Lesson Modal (if lesson selected) -->
    {% if selected_lesson %}
    <div class="lesson-modal" id="lessonModal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeLesson()">&times;</button>
        <h2>{{ selected_lesson.icon }} {{ selected_lesson.title }}</h2>
        <div class="lesson-body">
          {{ selected_lesson.content|safe }}
          
          {% if selected_lesson.video_url %}
          <div class="video-container">
            <iframe src="{{ selected_lesson.video_url }}" allowfullscreen></iframe>
          </div>
          {% endif %}
        </div>
        
        {% if quiz %}
        <div class="quiz-section">
          <h3>{{ quiz.title }}</h3>
          <p>{{ quiz.description }}</p>
          <form method="post" action="{% url 'lessons:quiz_submit' quiz.id %}">
            {% csrf_token %}
            {% for question in quiz.questions.all %}
            <div class="question-block">
              <p class="question-text">{{ forloop.counter }}. {{ question.question_text }}</p>
              <div class="answers">
                {% for answer in question.answers.all %}
                <label class="answer-option">
                  <input type="radio" name="question_{{ question.id }}" value="{{ answer.id }}" required>
                  <span>{{ answer.answer_text }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
            <button type="submit" class="submit-quiz-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
          </form>
        </div>
        {% else %}
        <form method="post" action="{% url 'lessons:complete_lesson' selected_lesson.id %}">
          {% csrf_token %}
          <button type="submit" class="complete-lesson-btn">Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø±Ø³</button>
        </form>
        {% endif %}
      </div>
    </div>
    {% endif %}
{% endblock content %}

{% block extra_js %}
<script>
  // Django context variables
  const pathData = {
    id: {{ path.id }},
    title: "{{ path.title|escapejs }}",
    totalLessons: {{ total_lessons }},
    completedLessons: {{ completed_lessons }},
    progressPercentage: {{ progress_percentage }}
  };

  const lessons = [
    {% for lesson_data in lessons_data %}
    {
      id: {{ lesson_data.lesson.id }},
      title: "{{ lesson_data.lesson.title|escapejs }}",
      status: "{{ lesson_data.status }}",
      isLocked: {{ lesson_data.is_locked|yesno:"true,false" }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Open Lesson Function
  function openLesson(lessonId) {
    window.location.href = "{% url 'lessons:learning_path' %}?lesson=" + lessonId;
  }

  // Show Locked Message
  function showLockedMessage() {
    alert("ğŸ”’ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ù…Ù‚ÙÙ„!\n\nØ£ÙƒÙ…Ù„ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.");
  }

  // Continue Current Lesson
  function continueCurrentLesson() {
    const inProgressLesson = lessons.find(l => l.status === 'inprogress');
    const unlockedLesson = lessons.find(l => l.status === 'unlocked');
    
    if (inProgressLesson) {
      openLesson(inProgressLesson.id);
    } else if (unlockedLesson) {
      openLesson(unlockedLesson.id);
    } else {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø±Ø³ Ù…ØªØ§Ø­ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.");
    }
  }

  // Go Back
  function goBack() {
    window.history.back();
  }

  // Close Lesson Modal
  function closeLesson() {
    window.location.href = "{% url 'lessons:learning_path' %}";
  }

  // Animate Progress Bar on Load
  window.addEventListener("load", function() {
    console.log(`%c ğŸ“ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ${pathData.title}! `, 
      "color: #4caf50; font-size: 20px; font-weight: bold;");
    console.log(`%c Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª ${pathData.progressPercentage}% Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±! Ø§Ø³ØªÙ…Ø±! ğŸŒŸ`, 
      "color: #ff9800; font-size: 14px;");

    // Scroll animation for lesson cards
    const observerOptions = {
      threshold: 0.1,
      rootMargin: "0px 0px -50px 0px"
    };

    const observer = new IntersectionObserver(function(entries) {
      entries.forEach((entry, index) => {
        if (entry.isIntersecting) {
          setTimeout(() => {
            entry.target.style.animation = "slideInRight 0.5s ease-out";
            entry.target.style.opacity = "1";
          }, index * 100);
        }
      });
    }, observerOptions);

    document.querySelectorAll(".lesson-card").forEach(card => {
      card.style.opacity = "0";
      observer.observe(card);
    });
  });

  // Add slide animation
  const style = document.createElement("style");
  style.textContent = `
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(-50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  `;
  document.head.appendChild(style);

  // Keyboard Navigation
  document.addEventListener("keydown", function(e) {
    if (e.key === "ArrowRight") {
      continueCurrentLesson();
    } else if (e.key === "ArrowLeft") {
      goBack();
    } else if (e.key === "Escape") {
      closeLesson();
    }
  });

  // Interactive lesson card click effects
  document.querySelectorAll(".lesson-card").forEach(card => {
    card.addEventListener("click", function() {
      if (!this.classList.contains("locked")) {
        this.style.transform = "scale(0.98)";
        setTimeout(() => {
          this.style.transform = "";
        }, 100);
      }
    });
  });
</script>
{% endblock extra_js %}