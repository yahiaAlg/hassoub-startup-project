<!DOCTYPE html>
<html lang="en">
{% load static %}
  <head>
    <meta name="x-poe-datastore-behavior" content="local_only" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snow Removal Service - BizKids Business Simulation</title>
    <link rel="stylesheet" href="{% static "css/scenarios/snow-removal-service.css" %}" />
    <script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header class="game-header">
      <div class="header-content">
        <div class="game-title">
          <span style="font-size: 2rem">‚ùÑÔ∏è</span>
          <div>
            <h1>Snow Removal Service</h1>
            <div style="font-size: 0.875rem; opacity: 0.9">
              Winter Business Simulation
            </div>
          </div>
        </div>
        <div class="header-stats" id="headerStats">
          <div class="header-stat">
            <div class="header-stat-label">Cash</div>
            <div class="header-stat-value">
              $<span id="headerCash">120</span>
            </div>
          </div>
          <div class="header-stat">
            <div class="header-stat-label">Week</div>
            <div class="header-stat-value">
              <span id="headerWeek">1</span>/8
            </div>
          </div>
          <div class="header-stat">
            <div class="header-stat-label">Profit</div>
            <div class="header-stat-value">
              $<span id="headerProfit">0</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
      <!-- Setup will be dynamically inserted here -->
    </div>

    <!-- Modals will be inserted dynamically -->

    <script>
      // Game State
      const gameState = {
        phase: "setup",
        currentStep: 1,
        cash: 120,
        initialCash: 120,
        week: 0,
        totalWeeks: 8,

        // Choices
        equipment: null,
        territory: null,
        pricingModel: null,
        serviceLevel: null,
        marketing: null,
        scheduling: null,

        // Business metrics
        totalProfit: 0,
        totalRevenue: 0,
        totalExpenses: 0,
        totalJobsCompleted: 0,
        totalHoursWorked: 0,
        customerSatisfaction: [],
        reputation: 5.0,
        fatigue: 0,

        // Customers
        contractCustomers: [],
        availableCustomers: [],
        completedJobs: [],

        // Weather history
        weatherHistory: [],
        storms: 0,

        // Week data
        weekRevenue: 0,
        weekExpenses: 0,
        weekJobs: 0,
      };

      // Equipment configurations
      const equipment = {
        basic: {
          name: "Basic Setup",
          price: 20,
          icon: "ü™£",
          speed: 45,
          capacity: "small",
          operatingCost: 0,
          maintenance: 0,
          fatigueFactor: 1.5,
        },
        standard: {
          name: "Standard Setup",
          price: 60,
          icon: "‚õèÔ∏è",
          speed: 30,
          capacity: "medium",
          operatingCost: 2,
          maintenance: 0,
          fatigueFactor: 1.0,
        },
        professional: {
          name: "Professional Setup",
          price: 110,
          icon: "üöú",
          speed: 12,
          capacity: "large",
          operatingCost: 3,
          maintenance: 5,
          fatigueFactor: 0.5,
        },
        partnership: {
          name: "Partnership",
          price: 40,
          icon: "ü§ù",
          speed: 15,
          capacity: "large",
          operatingCost: 2,
          maintenance: 3,
          fatigueFactor: 0.7,
          profitSplit: 0.5,
        },
      };

      // Initialize game
      function initGame() {
        showSetupStep(1);
      }

      // Show setup step
      function showSetupStep(step) {
        gameState.currentStep = step;
        const container = document.getElementById("mainContainer");

        switch (step) {
          case 1:
            container.innerHTML = createEquipmentStep();
            break;
          case 2:
            container.innerHTML = createTerritoryStep();
            break;
          case 3:
            container.innerHTML = createPricingStep();
            break;
          case 4:
            container.innerHTML = createServiceLevelStep();
            break;
          case 5:
            container.innerHTML = createMarketingStep();
            break;
          case 6:
            container.innerHTML = createSchedulingStep();
            break;
          case 7:
            startWinter();
            break;
        }
      }

      // Create equipment selection step
      function createEquipmentStep() {
        return `
                <div class="setup-container">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h2 class="step-title">Choose Your Equipment</h2>
                        <p class="step-description">What equipment will you invest in?</p>
                    </div>

                    <div class="options-grid">
                        ${Object.entries(equipment)
                          .map(
                            ([key, eq]) => `
                            <div class="option-card" onclick="selectEquipment('${key}')" id="eq-${key}">
                                <div class="option-icon">${eq.icon}</div>
                                <div class="option-name">${eq.name}</div>
                                <div class="option-price">$${eq.price}</div>
                                <ul class="option-details">
                                    <li>Clear in ${eq.speed} min</li>
                                    <li>${
                                      eq.capacity.charAt(0).toUpperCase() +
                                      eq.capacity.slice(1)
                                    } jobs</li>
                                    <li>Operating: $${eq.operatingCost}/job</li>
                                    ${
                                      eq.maintenance > 0
                                        ? `<li>Maintenance: $${eq.maintenance}/week</li>`
                                        : ""
                                    }
                                    ${
                                      eq.profitSplit
                                        ? `<li>Split profits 50/50</li>`
                                        : ""
                                    }
                                </ul>
                            </div>
                        `
                          )
                          .join("")}
                    </div>

                    <div class="info-box">
                        <div class="info-box-title">üí° Pro Tip</div>
                        <p>Better equipment increases speed and capacity, but costs more upfront and to operate. Consider your budget and expected workload!</p>
                    </div>

                    <div class="btn-container">
                        <button class="btn btn-primary" onclick="showSetupStep(2)" id="nextBtn" disabled>
                            Next Step ‚Üí
                        </button>
                    </div>
                </div>
            `;
      }

      // Select equipment
      function selectEquipment(type) {
        gameState.equipment = type;
        gameState.cash -= equipment[type].price;
        gameState.totalExpenses += equipment[type].price;

        // Update UI
        document.querySelectorAll(".option-card").forEach((card) => {
          card.classList.remove("selected");
        });
        document.getElementById(`eq-${type}`).classList.add("selected");
        document.getElementById("nextBtn").disabled = false;

        updateHeader();
      }

      // Create territory selection step
      function createTerritoryStep() {
        return `
                <div class="setup-container">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h2 class="step-title">Choose Your Territory</h2>
                        <p class="step-description">How far will you travel for jobs?</p>
                    </div>

                    <div class="options-grid">
                        <div class="option-card" onclick="selectTerritory('street')" id="territory-street">
                            <div class="option-icon">üèòÔ∏è</div>
                            <div class="option-name">Own Street Only</div>
                            <div class="option-price">Free</div>
                            <ul class="option-details">
                                <li>15-20 potential customers</li>
                                <li>Zero travel time</li>
                                <li>Quick response time</li>
                                <li>Neighbors trust you</li>
                                <li>Limited market size</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectTerritory('neighborhood')" id="territory-neighborhood">
                            <div class="option-icon">üèòÔ∏èüèòÔ∏èüèòÔ∏è</div>
                            <div class="option-name">Neighborhood</div>
                            <div class="option-price">Free</div>
                            <ul class="option-details">
                                <li>50-80 potential customers</li>
                                <li>5-10 min travel between jobs</li>
                                <li>Route planning needed</li>
                                <li>Good market size</li>
                                <li>Weather affects travel</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectTerritory('extended')" id="territory-extended">
                            <div class="option-icon">üåç</div>
                            <div class="option-name">Extended Area</div>
                            <div class="option-price">Free</div>
                            <ul class="option-details">
                                <li>120-150 potential customers</li>
                                <li>15-20 min travel time</li>
                                <li>May need rides</li>
                                <li>Maximum market</li>
                                <li>Travel challenging in snow</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-box">
                        <div class="info-box-title">üí° Pro Tip</div>
                        <p>Bigger territory means more customers but more time wasted traveling. Balance market size with efficiency!</p>
                    </div>

                    <div class="btn-container">
                        <button class="btn btn-secondary" onclick="showSetupStep(1)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="showSetupStep(3)" id="nextBtn" disabled>
                            Next Step ‚Üí
                        </button>
                    </div>
                </div>
            `;
      }

      // Select territory
      function selectTerritory(type) {
        gameState.territory = type;

        document.querySelectorAll(".option-card").forEach((card) => {
          card.classList.remove("selected");
        });
        document.getElementById(`territory-${type}`).classList.add("selected");
        document.getElementById("nextBtn").disabled = false;
      }

      // Create pricing step
      function createPricingStep() {
        return `
                <div class="setup-container">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <h2 class="step-title">Set Your Pricing Strategy</h2>
                        <p class="step-description">How will you charge for your services?</p>
                    </div>

                    <div class="options-grid">
                        <div class="option-card" onclick="selectPricing('per-job')" id="pricing-per-job">
                            <div class="option-icon">üíµ</div>
                            <div class="option-name">Per-Job Pricing</div>
                            <ul class="option-details">
                                <li>Charge per snowfall</li>
                                <li>Light snow: $25</li>
                                <li>Moderate: $40</li>
                                <li>Heavy: $60</li>
                                <li>Customer pays when it snows</li>
                                <li>High upside if heavy winter</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectPricing('contract')" id="pricing-contract">
                            <div class="option-icon">üìã</div>
                            <div class="option-name">Season Contract</div>
                            <ul class="option-details">
                                <li>Fixed price: $200/season</li>
                                <li>Customer pays upfront</li>
                                <li>Guaranteed income</li>
                                <li>Clear every snowfall</li>
                                <li>You take weather risk</li>
                                <li>Predictable revenue</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectPricing('mixed')" id="pricing-mixed">
                            <div class="option-icon">‚öñÔ∏è</div>
                            <div class="option-name">Mixed Strategy</div>
                            <ul class="option-details">
                                <li>40% contract customers</li>
                                <li>60% per-job customers</li>
                                <li>Balanced risk/reward</li>
                                <li>Steady base income</li>
                                <li>Upside potential</li>
                                <li>Best of both worlds</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-box">
                        <div class="info-box-title">üí° Pro Tip</div>
                        <p>Contracts guarantee income but transfer weather risk to YOU. Per-job pricing means you earn only when it snows!</p>
                    </div>

                    <div class="btn-container">
                        <button class="btn btn-secondary" onclick="showSetupStep(2)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="showSetupStep(4)" id="nextBtn" disabled>
                            Next Step ‚Üí
                        </button>
                    </div>
                </div>
            `;
      }

      // Select pricing
      function selectPricing(type) {
        gameState.pricingModel = type;

        document.querySelectorAll(".option-card").forEach((card) => {
          card.classList.remove("selected");
        });
        document.getElementById(`pricing-${type}`).classList.add("selected");
        document.getElementById("nextBtn").disabled = false;
      }

      // Create service level step
      function createServiceLevelStep() {
        return `
                <div class="setup-container">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <h2 class="step-title">Choose Service Quality</h2>
                        <p class="step-description">What level of service will you offer?</p>
                    </div>

                    <div class="options-grid">
                        <div class="option-card" onclick="selectServiceLevel('basic')" id="service-basic">
                            <div class="option-icon">‚≠ê</div>
                            <div class="option-name">Basic Service</div>
                            <ul class="option-details">
                                <li>Clear driveway only</li>
                                <li>Snow pushed to sides</li>
                                <li>No ice melt</li>
                                <li>Fast but minimal</li>
                                <li>Lower prices (-20%)</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectServiceLevel('standard')" id="service-standard">
                            <div class="option-icon">‚≠ê‚≠ê</div>
                            <div class="option-name">Standard Service</div>
                            <ul class="option-details">
                                <li>Clear driveway + walkway</li>
                                <li>Apply ice melt</li>
                                <li>Tidy snow piles</li>
                                <li>Good quality</li>
                                <li>Standard prices</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectServiceLevel('premium')" id="service-premium">
                            <div class="option-icon">‚≠ê‚≠ê‚≠ê</div>
                            <div class="option-name">Premium Service</div>
                            <ul class="option-details">
                                <li>Everything + sidewalk</li>
                                <li>Shovel porch/steps</li>
                                <li>Extra ice melt</li>
                                <li>Neat placement</li>
                                <li>Higher prices (+50%)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-box">
                        <div class="info-box-title">üí° Pro Tip</div>
                        <p>Premium service takes longer but commands higher prices. Elderly customers prefer premium for safety!</p>
                    </div>

                    <div class="btn-container">
                        <button class="btn btn-secondary" onclick="showSetupStep(3)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="showSetupStep(5)" id="nextBtn" disabled>
                            Next Step ‚Üí
                        </button>
                    </div>
                </div>
            `;
      }

      // Select service level
      function selectServiceLevel(type) {
        gameState.serviceLevel = type;

        document.querySelectorAll(".option-card").forEach((card) => {
          card.classList.remove("selected");
        });
        document.getElementById(`service-${type}`).classList.add("selected");
        document.getElementById("nextBtn").disabled = false;
      }

      // Create marketing step
      function createMarketingStep() {
        return `
                <div class="setup-container">
                    <div class="step-header">
                        <div class="step-number">5</div>
                        <h2 class="step-title">Marketing Strategy</h2>
                        <p class="step-description">How will you get customers?</p>
                    </div>

                    <div class="options-grid">
                        <div class="option-card" onclick="selectMarketing('flyers')" id="marketing-flyers">
                            <div class="option-icon">üìÑ</div>
                            <div class="option-name">Door-to-Door Flyers</div>
                            <div class="option-price">$10</div>
                            <ul class="option-details">
                                <li>Personal touch</li>
                                <li>50 homes reached</li>
                                <li>15-20% interest rate</li>
                                <li>Good for local area</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectMarketing('signs')" id="marketing-signs">
                            <div class="option-icon">ü™ß</div>
                            <div class="option-name">Yard Signs</div>
                            <div class="option-price">$15</div>
                            <ul class="option-details">
                                <li>Visible all season</li>
                                <li>100+ people see</li>
                                <li>8-12% contact rate</li>
                                <li>Professional look</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectMarketing('email')" id="marketing-email">
                            <div class="option-icon">üìß</div>
                            <div class="option-name">Email Campaign</div>
                            <div class="option-price">Free</div>
                            <ul class="option-details">
                                <li>Digital marketing</li>
                                <li>80+ families reached</li>
                                <li>10% response rate</li>
                                <li>Easy to update</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-box">
                        <div class="info-box-title">üí° Pro Tip</div>
                        <p>Get customers BEFORE winter starts! Pre-season contracts guarantee income.</p>
                    </div>

                    <div class="btn-container">
                        <button class="btn btn-secondary" onclick="showSetupStep(4)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="showSetupStep(6)" id="nextBtn" disabled>
                            Next Step ‚Üí
                        </button>
                    </div>
                </div>
            `;
      }

      // Select marketing
      function selectMarketing(type) {
        const costs = { flyers: 10, signs: 15, email: 0 };
        if (gameState.cash >= costs[type]) {
          gameState.marketing = type;
          gameState.cash -= costs[type];
          gameState.totalExpenses += costs[type];

          document.querySelectorAll(".option-card").forEach((card) => {
            card.classList.remove("selected");
          });
          document
            .getElementById(`marketing-${type}`)
            .classList.add("selected");
          document.getElementById("nextBtn").disabled = false;

          updateHeader();
        } else {
          alert("Not enough cash!");
        }
      }

      // Create scheduling step
      function createSchedulingStep() {
        return `
                <div class="setup-container">
                    <div class="step-header">
                        <div class="step-number">6</div>
                        <h2 class="step-title">Scheduling Philosophy</h2>
                        <p class="step-description">When will you clear snow?</p>
                    </div>

                    <div class="options-grid">
                        <div class="option-card" onclick="selectScheduling('during')" id="schedule-during">
                            <div class="option-icon">üå®Ô∏è</div>
                            <div class="option-name">During Storm</div>
                            <ul class="option-details">
                                <li>Start while snowing</li>
                                <li>Prevents buildup</li>
                                <li>May need second pass</li>
                                <li>Shows dedication</li>
                                <li>Difficult conditions</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectScheduling('after')" id="schedule-after">
                            <div class="option-icon">‚è±Ô∏è</div>
                            <div class="option-name">After Storm</div>
                            <ul class="option-details">
                                <li>Wait until snow stops</li>
                                <li>Clear once (efficient)</li>
                                <li>High demand</li>
                                <li>Race competitors</li>
                                <li>Customers want it NOW</li>
                            </ul>
                        </div>

                        <div class="option-card" onclick="selectScheduling('morning')" id="schedule-morning">
                            <div class="option-icon">üåÖ</div>
                            <div class="option-name">Next Morning</div>
                            <ul class="option-details">
                                <li>Clear in daylight</li>
                                <li>Safer & easier</li>
                                <li>Less urgent</li>
                                <li>More competition</li>
                                <li>Lower perceived value</li>
                            </ul>
                        </div>
                    </div>

                    <div class="info-box">
                        <div class="info-box-title">üí° Pro Tip</div>
                        <p>Service timing affects customer satisfaction and tips. Early service = happy customers!</p>
                    </div>

                    <div class="btn-container">
                        <button class="btn btn-secondary" onclick="showSetupStep(5)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="showSetupStep(7)" id="nextBtn" disabled>
                            Start Winter! ‚ùÑÔ∏è
                        </button>
                    </div>
                </div>
            `;
      }

      // Select scheduling
      function selectScheduling(type) {
        gameState.scheduling = type;

        document.querySelectorAll(".option-card").forEach((card) => {
          card.classList.remove("selected");
        });
        document.getElementById(`schedule-${type}`).classList.add("selected");
        document.getElementById("nextBtn").disabled = false;
      }

      // Start winter simulation
      function startWinter() {
        gameState.phase = "playing";
        generateCustomers();
        startWeek(1);
      }

      // Generate customers based on marketing
      function generateCustomers() {
        const marketingReach = {
          flyers: { count: 50, rate: 0.18 },
          signs: { count: 100, rate: 0.1 },
          email: { count: 80, rate: 0.1 },
        };

        const reach = marketingReach[gameState.marketing];
        const interestedCount = Math.floor(reach.count * reach.rate);

        // Generate contract customers if applicable
        if (
          gameState.pricingModel === "contract" ||
          gameState.pricingModel === "mixed"
        ) {
          const contractRatio =
            gameState.pricingModel === "contract" ? 0.8 : 0.4;
          const contractCount = Math.floor(interestedCount * contractRatio);

          for (let i = 0; i < contractCount; i++) {
            const customer = generateCustomer(true);
            gameState.contractCustomers.push(customer);
            // Collect contract payment upfront
            gameState.cash += 200;
            gameState.totalRevenue += 200;
          }
        }
      }

      // Generate a customer
      function generateCustomer(isContract = false) {
        const names = [
          "Smith",
          "Johnson",
          "Williams",
          "Brown",
          "Jones",
          "Garcia",
          "Miller",
          "Davis",
        ];
        const types = ["Small", "Medium", "Large"];
        const ages = ["young", "middle", "elderly"];

        return {
          name: names[Math.floor(Math.random() * names.length)] + " Family",
          type: types[Math.floor(Math.random() * types.length)],
          age: ages[Math.floor(Math.random() * ages.length)],
          isContract: isContract,
          satisfaction: 0,
          tipped: false,
        };
      }

      // Start a new week
      function startWeek(weekNumber) {
        gameState.week = weekNumber;
        gameState.weekRevenue = 0;
        gameState.weekExpenses = 0;
        gameState.weekJobs = 0;

        // Generate weather
        const weather = generateWeather();
        gameState.weatherHistory.push(weather);

        updateHeader();

        if (weather.snowfall > 0) {
          // Storm!
          gameState.storms++;
          showStorm(weather);
        } else {
          // No snow
          showNoSnow(weather);
        }
      }

      // Generate weather for the week
      function generateWeather() {
        const rand = Math.random();

        if (rand < 0.4) {
          return {
            type: "clear",
            snowfall: 0,
            icon: "‚òÄÔ∏è",
            description: "Clear & Cold",
          };
        } else if (rand < 0.7) {
          return {
            type: "light",
            snowfall: 3,
            icon: "üå®Ô∏è",
            description: "Light Snow",
            multiplier: 1.0,
          };
        } else if (rand < 0.9) {
          return {
            type: "moderate",
            snowfall: 6,
            icon: "‚ùÑÔ∏è",
            description: "Moderate Snow",
            multiplier: 1.5,
          };
        } else if (rand < 0.95) {
          return {
            type: "heavy",
            snowfall: 10,
            icon: "üå®Ô∏è‚ùÑÔ∏è",
            description: "Heavy Snow",
            multiplier: 2.0,
          };
        } else {
          return {
            type: "blizzard",
            snowfall: 14,
            icon: "üå™Ô∏è‚ùÑÔ∏è",
            description: "BLIZZARD!",
            multiplier: 2.5,
          };
        }
      }

      // Show storm week
      function showStorm(weather) {
        createSnowfall();

        // Generate customer calls
        const demandRate =
          weather.snowfall < 5 ? 0.2 : weather.snowfall < 8 ? 0.5 : 0.8;
        const maxCustomers =
          gameState.territory === "street"
            ? 15
            : gameState.territory === "neighborhood"
            ? 60
            : 120;
        const callCount = Math.floor(maxCustomers * demandRate);

        const availableCustomers = [];
        for (let i = 0; i < callCount; i++) {
          availableCustomers.push(generateCustomer(false));
        }
        gameState.availableCustomers = availableCustomers;

        const container = document.getElementById("mainContainer");
        container.innerHTML = `
                <div class="game-board">
                    <div class="main-panel">
                        <div class="week-header">
                            <div class="week-number">Week ${
                              gameState.week
                            }</div>
                            <div class="weather-display">
                                <span class="weather-icon">${
                                  weather.icon
                                }</span>
                                <div>
                                    <div>${weather.description}</div>
                                    <div style="font-size: 1rem; opacity: 0.9;">${
                                      weather.snowfall
                                    } inches of snow</div>
                                </div>
                            </div>
                        </div>

                        <div class="storm-card">
                            <div class="storm-intensity">
                                <span class="snow-depth">${
                                  weather.snowfall
                                }"</span>
                                <div>
                                    <div style="font-weight: 700; font-size: 1.25rem;">Active Storm</div>
                                    <div style="color: var(--winter-gray);">Customer calls coming in!</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                üìû <strong>${callCount}</strong> customers requesting service
                            </div>
                        </div>

                        <div class="panel-title">üìã Customer Queue</div>
                        <div class="customer-queue" id="customerQueue">
                            ${gameState.contractCustomers
                              .map(
                                (c, i) => `
                                <div class="customer-item contract">
                                    <div class="customer-info">
                                        <div class="customer-name">‚úÖ ${c.name} (Contract)</div>
                                        <div class="customer-details">${c.type} Driveway ‚Ä¢ Must complete</div>
                                    </div>
                                    <div class="job-price">Required</div>
                                </div>
                            `
                              )
                              .join("")}
                            ${availableCustomers
                              .slice(0, 10)
                              .map((c, i) => {
                                const price = calculateJobPrice(
                                  c.type,
                                  weather.snowfall
                                );
                                return `
                                    <div class="customer-item">
                                        <div class="customer-info">
                                            <div class="customer-name">${c.name}</div>
                                            <div class="customer-details">${c.type} Driveway ‚Ä¢ ${weather.snowfall} inches</div>
                                        </div>
                                        <div class="job-price">$${price}</div>
                                    </div>
                                `;
                              })
                              .join("")}
                            ${
                              availableCustomers.length > 10
                                ? `
                                <div style="text-align: center; padding: 1rem; color: var(--winter-gray);">
                                    +${
                                      availableCustomers.length - 10
                                    } more customers waiting...
                                </div>
                            `
                                : ""
                            }
                        </div>

                        <div class="btn-container" style="margin-top: 2rem;">
                            <button class="btn btn-primary" onclick="executeStormDay('${JSON.stringify(
                              weather
                            ).replace(/"/g, "&quot;")}')">
                                üöú Start Working!
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-panel">
                        ${createSidebarPanels()}
                    </div>
                </div>
            `;
      }

      // Calculate job price
      function calculateJobPrice(type, snowfall) {
        let basePrice = 25;
        if (snowfall >= 8) basePrice = 60;
        else if (snowfall >= 4) basePrice = 40;

        const sizeMultiplier =
          type === "Small" ? 0.8 : type === "Large" ? 1.3 : 1.0;
        const serviceMultiplier =
          gameState.serviceLevel === "basic"
            ? 0.8
            : gameState.serviceLevel === "premium"
            ? 1.5
            : 1.0;

        return Math.round(basePrice * sizeMultiplier * serviceMultiplier);
      }

      // Execute storm day
      function executeStormDay(weatherStr) {
        const weather = JSON.parse(weatherStr.replace(/&quot;/g, '"'));

        // Calculate capacity
        const equipSpeed = equipment[gameState.equipment].speed;
        const availableHours = 8; // Assume full day available
        const travelTime =
          gameState.territory === "street"
            ? 0
            : gameState.territory === "neighborhood"
            ? 7
            : 15;

        // Time per job
        const baseTime = equipSpeed * (weather.snowfall / 6); // Adjust for snow depth
        const totalTimePerJob = baseTime + travelTime;
        const maxJobs = Math.floor((availableHours * 60) / totalTimePerJob);

        // Process contract customers first
        let jobsCompleted = 0;
        let revenue = 0;
        let expenses = 0;
        const jobResults = [];

        // Contract customers (must do)
        gameState.contractCustomers.forEach((customer) => {
          if (jobsCompleted < maxJobs) {
            const result = completeJob(customer, weather, true);
            jobResults.push(result);
            expenses += equipment[gameState.equipment].operatingCost;
            jobsCompleted++;
          }
        });

        // Additional per-job customers
        const remainingCapacity = maxJobs - jobsCompleted;
        const perJobCustomers = gameState.availableCustomers.slice(
          0,
          remainingCapacity
        );

        perJobCustomers.forEach((customer) => {
          const result = completeJob(customer, weather, false);
          jobResults.push(result);
          revenue += calculateJobPrice(customer.type, weather.snowfall);
          expenses += equipment[gameState.equipment].operatingCost;
          jobsCompleted++;
        });

        // Add maintenance
        if (equipment[gameState.equipment].maintenance) {
          expenses += equipment[gameState.equipment].maintenance;
        }

        // Update state
        gameState.cash += revenue - expenses;
        gameState.totalRevenue += revenue;
        gameState.totalExpenses += expenses;
        gameState.totalJobsCompleted += jobsCompleted;
        gameState.weekJobs = jobsCompleted;
        gameState.weekRevenue = revenue;
        gameState.weekExpenses = expenses;
        gameState.fatigue = Math.min(
          100,
          gameState.fatigue +
            jobsCompleted * equipment[gameState.equipment].fatigueFactor * 5
        );

        updateHeader();
        showWeekResults(weather, jobResults, revenue, expenses);
      }

      // Complete a job
      function completeJob(customer, weather, isContract) {
        const schedulingBonus = {
          during: 1.2,
          after: 1.0,
          morning: 0.8,
        };

        const serviceBonus = {
          basic: 0.8,
          standard: 1.0,
          premium: 1.3,
        };

        let satisfaction = 70;
        satisfaction += (schedulingBonus[gameState.scheduling] - 1) * 30;
        satisfaction += (serviceBonus[gameState.serviceLevel] - 1) * 20;
        satisfaction += Math.random() * 20 - 10; // Random factor

        // Elderly prefer premium
        if (
          customer.age === "elderly" &&
          gameState.serviceLevel === "premium"
        ) {
          satisfaction += 15;
        }

        satisfaction = Math.max(0, Math.min(100, satisfaction));

        const tip =
          satisfaction > 85 && Math.random() < 0.3
            ? Math.floor(Math.random() * 10) + 5
            : 0;

        if (tip > 0) {
          gameState.cash += tip;
          gameState.totalRevenue += tip;
        }

        gameState.customerSatisfaction.push(satisfaction);

        return {
          customer,
          satisfaction,
          tip,
          isContract,
        };
      }

      // Show no snow week
      function showNoSnow(weather) {
        const container = document.getElementById("mainContainer");
        container.innerHTML = `
                <div class="game-board">
                    <div class="main-panel">
                        <div class="week-header">
                            <div class="week-number">Week ${
                              gameState.week
                            }</div>
                            <div class="weather-display">
                                <span class="weather-icon">${
                                  weather.icon
                                }</span>
                                <div>
                                    <div>${weather.description}</div>
                                    <div style="font-size: 1rem; opacity: 0.9;">No snow this week</div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; padding: 4rem 2rem;">
                            <div style="font-size: 5rem; margin-bottom: 1rem;">‚òÄÔ∏è</div>
                            <h2 style="font-size: 2rem; font-weight: 800; margin-bottom: 1rem; color: var(--dark-blue);">
                                Quiet Week
                            </h2>
                            <p style="color: var(--winter-gray); font-size: 1.125rem; margin-bottom: 2rem;">
                                No snow means no work this week. Your equipment sits idle, but you can rest and recover!
                            </p>
                            ${
                              gameState.contractCustomers.length > 0
                                ? `
                                <div class="info-box">
                                    <div class="info-box-title">üí∞ Contract Benefits</div>
                                    <p>Your ${gameState.contractCustomers.length} contract customers already paid upfront. 
                                    This is a profitable week for you!</p>
                                </div>
                            `
                                : `
                                <div class="info-box">
                                    <div class="info-box-title">üìâ No Revenue</div>
                                    <p>With per-job pricing, you earn nothing this week. Weather uncertainty is part of the business!</p>
                                </div>
                            `
                            }
                        </div>

                        <div class="btn-container">
                            <button class="btn btn-primary" onclick="continueToNextWeek()">
                                Continue to Next Week ‚Üí
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-panel">
                        ${createSidebarPanels()}
                    </div>
                </div>
            `;

        // Reduce fatigue on rest days
        gameState.fatigue = Math.max(0, gameState.fatigue - 15);
      }

      // Show week results
      function showWeekResults(weather, jobResults, revenue, expenses) {
        const avgSatisfaction =
          jobResults.reduce((sum, r) => sum + r.satisfaction, 0) /
          jobResults.length;
        const totalTips = jobResults.reduce((sum, r) => sum + r.tip, 0);

        const modal = document.createElement("div");
        modal.className = "modal active";
        modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-icon">${weather.icon}</div>
                        <h2 class="modal-title">Week ${
                          gameState.week
                        } Complete!</h2>
                        <p style="color: var(--winter-gray); font-size: 1.125rem;">
                            ${weather.description} - ${weather.snowfall} inches
                        </p>
                    </div>

                    <div class="results-section">
                        <h3>Performance Summary</h3>
                        <div class="result-row">
                            <span class="result-label">Jobs Completed</span>
                            <span class="result-value">${
                              jobResults.length
                            }</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Revenue</span>
                            <span class="result-value" style="color: var(--success-green);">$${revenue.toFixed(
                              2
                            )}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Expenses</span>
                            <span class="result-value" style="color: var(--danger-red);">$${expenses.toFixed(
                              2
                            )}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Week Profit</span>
                            <span class="result-value" style="color: ${
                              revenue - expenses > 0
                                ? "var(--success-green)"
                                : "var(--danger-red)"
                            };">
                                $${(revenue - expenses).toFixed(2)}
                            </span>
                        </div>
                        ${
                          totalTips > 0
                            ? `
                            <div class="result-row">
                                <span class="result-label">üí∞ Tips Earned</span>
                                <span class="result-value" style="color: var(--success-green);">$${totalTips}</span>
                            </div>
                        `
                            : ""
                        }
                        <div class="result-row">
                            <span class="result-label">Avg. Satisfaction</span>
                            <span class="result-value">${avgSatisfaction.toFixed(
                              1
                            )}%</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Current Fatigue</span>
                            <span class="result-value">${gameState.fatigue.toFixed(
                              0
                            )}%</span>
                        </div>
                    </div>

                    ${
                      avgSatisfaction > 85
                        ? `
                        <div class="info-box">
                            <div class="info-box-title">‚≠ê Excellent Service!</div>
                            <p>Your customers loved your work! High satisfaction builds reputation and referrals.</p>
                        </div>
                    `
                        : avgSatisfaction < 60
                        ? `
                        <div class="info-box" style="border-left-color: var(--danger-red);">
                            <div class="info-box-title">‚ö†Ô∏è Service Issues</div>
                            <p>Customer satisfaction is low. Consider improving timing or service quality.</p>
                        </div>
                    `
                        : ""
                    }

                    <div class="btn-container">
                        <button class="btn btn-primary" onclick="continueToNextWeek()">
                            ${
                              gameState.week < gameState.totalWeeks
                                ? "Continue to Week " + (gameState.week + 1)
                                : "View Final Results"
                            } ‚Üí
                        </button>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
      }

      // Continue to next week
      function continueToNextWeek() {
        // Remove modal if exists
        const modal = document.querySelector(".modal");
        if (modal) modal.remove();

        if (gameState.week < gameState.totalWeeks) {
          startWeek(gameState.week + 1);
        } else {
          showFinalResults();
        }
      }

      // Show final results
      function showFinalResults() {
        const avgSatisfaction =
          gameState.customerSatisfaction.length > 0
            ? gameState.customerSatisfaction.reduce((a, b) => a + b, 0) /
              gameState.customerSatisfaction.length
            : 0;

        const netProfit = gameState.totalRevenue - gameState.totalExpenses;
        const roi = ((netProfit / gameState.initialCash) * 100).toFixed(1);
        const avgJobRevenue =
          gameState.totalJobsCompleted > 0
            ? gameState.totalRevenue / gameState.totalJobsCompleted
            : 0;

        // Determine score
        let score = 0;
        if (netProfit > 400) score = 100;
        else if (netProfit > 250) score = 85;
        else if (netProfit > 150) score = 70;
        else if (netProfit > 75) score = 55;
        else score = 40;

        // Adjust for satisfaction
        if (avgSatisfaction > 85) score += 10;
        else if (avgSatisfaction < 60) score -= 10;

        const container = document.getElementById("mainContainer");
        container.innerHTML = `
                <div class="setup-container">
                    <div class="modal-header">
                        <div class="modal-icon">üèÜ</div>
                        <h2 class="modal-title">Winter Season Complete!</h2>
                        <p style="color: var(--winter-gray); font-size: 1.125rem;">8 weeks of snow removal service</p>
                    </div>

                    <div style="text-align: center; margin: 2rem 0;">
                        <div style="font-size: 4rem; font-weight: 800; color: var(--ice-blue);">
                            Score: ${score}/100
                        </div>
                        <div style="font-size: 1.25rem; color: var(--winter-gray); margin-top: 0.5rem;">
                            ${
                              score >= 85
                                ? "üåü Outstanding Performance!"
                                : score >= 70
                                ? "üëç Good Job!"
                                : score >= 55
                                ? "üìà Room for Improvement"
                                : "üí™ Keep Learning!"
                            }
                        </div>
                    </div>

                    <div class="results-section">
                        <h3>üí∞ Financial Performance</h3>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-label">Total Revenue</div>
                                <div class="stat-value" style="color: var(--success-green);">$${gameState.totalRevenue.toFixed(
                                  2
                                )}</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Total Expenses</div>
                                <div class="stat-value" style="color: var(--danger-red);">$${gameState.totalExpenses.toFixed(
                                  2
                                )}</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Net Profit</div>
                                <div class="stat-value" style="color: ${
                                  netProfit > 0
                                    ? "var(--success-green)"
                                    : "var(--danger-red)"
                                };">
                                    $${netProfit.toFixed(2)}
                                </div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">ROI</div>
                                <div class="stat-value">${roi}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="results-section">
                        <h3>üìä Operational Metrics</h3>
                        <div class="result-row">
                            <span class="result-label">Total Storms</span>
                            <span class="result-value">${
                              gameState.storms
                            }</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Jobs Completed</span>
                            <span class="result-value">${
                              gameState.totalJobsCompleted
                            }</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Avg Revenue/Job</span>
                            <span class="result-value">$${avgJobRevenue.toFixed(
                              2
                            )}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Contract Customers</span>
                            <span class="result-value">${
                              gameState.contractCustomers.length
                            }</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Avg Satisfaction</span>
                            <span class="result-value">${avgSatisfaction.toFixed(
                              1
                            )}%</span>
                        </div>
                    </div>

                    <div class="results-section">
                        <h3>‚ùÑÔ∏è Winter Timeline</h3>
                        <div class="winter-timeline">
                            ${gameState.weatherHistory
                              .map(
                                (w, i) => `
                                <div class="week-block ${
                                  w.snowfall > 0 ? "snow" : ""
                                }">
                                    <div class="week-block-number">Week ${
                                      i + 1
                                    }</div>
                                    <div class="week-block-icon">${w.icon}</div>
                                    ${
                                      w.snowfall > 0
                                        ? `<div style="font-size: 0.75rem;">${w.snowfall}"</div>`
                                        : ""
                                    }
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <div style="text-align: center; margin-top: 1rem; color: var(--winter-gray);">
                            ${
                              gameState.storms < 3
                                ? "This was a light winter"
                                : gameState.storms < 6
                                ? "This was a moderate winter"
                                : "This was a heavy winter"
                            }
                        </div>
                    </div>

                    <div class="info-box">
                        <div class="info-box-title">üìö Key Learnings</div>
                        <ul style="margin-top: 1rem; list-style: none;">
                            <li style="padding: 0.5rem 0;">‚Ä¢ Weather-dependent businesses face uncertainty‚Äîthat's business risk</li>
                            <li style="padding: 0.5rem 0;">‚Ä¢ ${
                              gameState.pricingModel === "contract"
                                ? "Contracts provided steady income but you took on weather risk"
                                : gameState.pricingModel === "per-job"
                                ? "Per-job pricing meant you only earned when it snowed"
                                : "Mixed pricing balanced risk and opportunity"
                            }</li>
                            <li style="padding: 0.5rem 0;">‚Ä¢ Service quality and timing affect customer satisfaction and referrals</li>
                            <li style="padding: 0.5rem 0;">‚Ä¢ Equipment investment pays off with ${
                              gameState.totalJobsCompleted
                            } jobs completed</li>
                        </ul>
                    </div>

                    <div class="btn-container">
                        <button class="btn btn-secondary" onclick="location.href='games.html'">
                            ‚Üê Back to Games
                        </button>
                        <button class="btn btn-primary" onclick="location.reload()">
                            üîÑ Play Again
                        </button>
                    </div>
                </div>
            `;
      }

      // Create sidebar panels
      function createSidebarPanels() {
        const avgSat =
          gameState.customerSatisfaction.length > 0
            ? gameState.customerSatisfaction.reduce((a, b) => a + b, 0) /
              gameState.customerSatisfaction.length
            : 0;

        return `
                <div class="panel">
                    <div class="panel-title">üìä Season Stats</div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Total Jobs</div>
                            <div class="stat-value">${
                              gameState.totalJobsCompleted
                            }</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Storms</div>
                            <div class="stat-value">${gameState.storms}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Revenue</div>
                            <div class="stat-value" style="font-size: 1.25rem;">$${gameState.totalRevenue.toFixed(
                              0
                            )}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Satisfaction</div>
                            <div class="stat-value" style="font-size: 1.25rem;">${avgSat.toFixed(
                              0
                            )}%</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">‚öôÔ∏è Your Setup</div>
                    <div style="font-size: 0.875rem;">
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--frost-blue);">
                            <strong>Equipment:</strong> ${
                              equipment[gameState.equipment].name
                            }
                        </div>
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--frost-blue);">
                            <strong>Territory:</strong> ${
                              gameState.territory.charAt(0).toUpperCase() +
                              gameState.territory.slice(1)
                            }
                        </div>
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--frost-blue);">
                            <strong>Pricing:</strong> ${
                              gameState.pricingModel === "per-job"
                                ? "Per-Job"
                                : gameState.pricingModel === "contract"
                                ? "Contract"
                                : "Mixed"
                            }
                        </div>
                        <div style="padding: 0.5rem 0;">
                            <strong>Service:</strong> ${
                              gameState.serviceLevel.charAt(0).toUpperCase() +
                              gameState.serviceLevel.slice(1)
                            }
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">üí™ Fatigue Level</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${
                          gameState.fatigue
                        }%; background: ${
          gameState.fatigue < 50
            ? "var(--success-green)"
            : gameState.fatigue < 75
            ? "var(--warning-orange)"
            : "var(--danger-red)"
        }">
                            ${gameState.fatigue.toFixed(0)}%
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--winter-gray); margin-top: 0.5rem; text-align: center;">
                        ${
                          gameState.fatigue < 50
                            ? "Feeling good!"
                            : gameState.fatigue < 75
                            ? "Getting tired..."
                            : "Exhausted! Need rest."
                        }
                    </div>
                </div>
            `;
      }

      // Update header
      function updateHeader() {
        document.getElementById("headerCash").textContent =
          gameState.cash.toFixed(0);
        document.getElementById("headerWeek").textContent = gameState.week;
        document.getElementById("headerProfit").textContent = (
          gameState.totalRevenue - gameState.totalExpenses
        ).toFixed(0);
      }

      // Create snowfall animation
      function createSnowfall() {
        const snowflakes = ["‚ùÑÔ∏è", "‚ùÖ", "‚ùÜ"];
        for (let i = 0; i < 20; i++) {
          setTimeout(() => {
            const snowflake = document.createElement("div");
            snowflake.className = "snowflake";
            snowflake.textContent =
              snowflakes[Math.floor(Math.random() * snowflakes.length)];
            snowflake.style.left = Math.random() * 100 + "%";
            snowflake.style.animationDuration = Math.random() * 3 + 2 + "s";
            snowflake.style.opacity = Math.random();
            document.body.appendChild(snowflake);

            setTimeout(() => snowflake.remove(), 5000);
          }, i * 200);
        }
      }

      // Initialize game on load
      window.addEventListener("load", initGame);
    </script>
  </body>
</html>
