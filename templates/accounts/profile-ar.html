{% extends "base.html" %}
{% load static %}

{% block title %}ูููู ุงูุดุฎุตู{% endblock title %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/accounts/profile.css' %}" />
{% endblock extra_css %}

{% block content %}
    <div class="profile-container">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-card">
          <div class="avatar">
            {% if profile.avatar %}
              <img src="{{ profile.avatar.url }}" alt="{{ user.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
            {% else %}
              ๐ค
            {% endif %}
          </div>
          <div class="username">{{ user.get_full_name|default:user.username }}</div>
          <div class="level-xp">
            <span class="level">ุงููุณุชูู {{ profile.level }}</span>
            <div class="xp-bar">
              <div class="xp-fill" style="width: {{ progress_percentage }}%"></div>
            </div>
            <span class="xp-percentage">{{ progress_percentage }}%</span>
          </div>
          <div class="member-since">ุนุถู ููุฐ {{ profile.created_at|date:"F Y" }}</div>
        </div>
      </div>

      <!-- Settings Container -->
      <div class="settings-container">
        <!-- Account Settings -->
        <div class="settings-section">
          <div class="section-title" onclick="toggleSection(this)">
            <span>โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุญุณุงุจ</span>
            <span class="section-icon">โผ</span>
          </div>
          <div class="section-content">
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</div>
                <div class="setting-description">ูู ุจุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุญุณุงุจู</div>
              </div>
              <div class="setting-control">
                <button class="change-password-btn" onclick="openPasswordModal()">
                  ุชุบููุฑ
                </button>
              </div>
            </div>
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">ุชูุถููุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</div>
                <div class="setting-description">ุฅุฏุงุฑุฉ ุฅุดุนุงุฑุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</div>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="receiveEmails" {% if profile.receive_emails %}checked{% endif %} />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Game Preferences -->
        <div class="settings-section">
          <div class="section-title" onclick="toggleSection(this)">
            <span>๐ฎ ุชูุถููุงุช ุงููุนุจุฉ</span>
            <span class="section-icon">โผ</span>
          </div>
          <div class="section-content">
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">ูุณุชูู ุงูุตุนูุจุฉ</div>
                <div class="setting-description">ุงุฎุชุฑ ูุณุชูู ุงูุชุญุฏู ุงูููุงุณุจ</div>
              </div>
              <div class="setting-control">
                <select class="select-box" id="difficulty">
                  <option value="auto">ุชุนุฏูู ุชููุงุฆู (ููุตู ุจู)</option>
                  <option value="easy">ุณูู</option>
                  <option value="medium">ูุชูุณุท</option>
                  <option value="hard">ุตุนุจ</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Notification Settings -->
        <div class="settings-section">
          <div class="section-title" onclick="toggleSection(this)">
            <span>๐ ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช</span>
            <span class="section-icon">โผ</span>
          </div>
          <div class="section-content">
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">ุงููุคุซุฑุงุช ุงูุตูุชูุฉ</div>
                <div class="setting-description">ุชุดุบูู/ุฅููุงู ุงูุฃุตูุงุช ูู ุงููุนุจุฉ</div>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="soundEffects" checked />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">ุงููุถุน ุงููููู</div>
                <div class="setting-description">ุชูุนูู ุงููุธูุฑ ุงูุฏุงูู</div>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="darkMode" />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">ุชููู ุงูุฅุดุนุงุฑุงุช</div>
                <div class="setting-description">ุฅุดุนุงุฑุงุช ุงูุชูุฏู ูุงูุฅูุฌุงุฒุงุช</div>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="receiveNotifications" {% if profile.receive_notifications %}checked{% endif %} />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Privacy Settings -->
        <div class="settings-section">
          <div class="section-title" onclick="toggleSection(this)">
            <span>๐ ุฅุนุฏุงุฏุงุช ุงูุฎุตูุตูุฉ</span>
            <span class="section-icon">โผ</span>
          </div>
          <div class="section-content">
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">ุธููุฑ ุงูููู ุงูุดุฎุตู</div>
                <div class="setting-description">ุงูุชุญูู ูู ูู ููููู ุฑุคูุฉ ูููู ุงูุดุฎุตู</div>
              </div>
              <div class="setting-control">
                <select class="select-box" id="profileVisibility">
                  <option value="public">ุนุงู (ูุฑุฆู ููุฌููุน)</option>
                  <option value="friends">ุงูุฃุตุฏูุงุก ููุท</option>
                  <option value="private">ุฎุงุต (ุฃูุง ููุท)</option>
                </select>
              </div>
            </div>
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">ุงููุดุงุฑูุฉ ูู ููุญุฉ ุงููุชุตุฏุฑูู</div>
                <div class="setting-description">ุงูุธููุฑ ูู ุชุตูููุงุช ุงููุงุนุจูู</div>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input type="checkbox" id="leaderboard" checked />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="settings-section">
          <div class="section-title" onclick="toggleSection(this)">
            <span>โ๏ธ ููุทูุฉ ุงูุฎุทุฑ</span>
            <span class="section-icon">โผ</span>
          </div>
          <div class="section-content">
            <div class="danger-zone">
              <div class="danger-title">
                <span>๐๏ธ</span>
                <span>ุญุฐู ุงูุญุณุงุจ</span>
              </div>
              <p class="danger-description">
                ุญุฐู ุญุณุงุจู ููุงุฆูุงู ูุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ุจู. ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.
              </p>
              <button class="delete-account-btn" onclick="openDeleteModal()">
                ุญุฐู ุงูุญุณุงุจ
              </button>
            </div>
          </div>
        </div>

        <form method="post" action="{% url 'accounts:profile' %}" id="settingsForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_profile">
          <input type="hidden" name="first_name" id="firstNameInput" value="{{ user.first_name }}">
          <input type="hidden" name="last_name" id="lastNameInput" value="{{ user.last_name }}">
          <input type="hidden" name="email" id="emailInput" value="{{ user.email }}">
          <input type="hidden" name="phone" id="phoneInput" value="{{ profile.phone }}">
          <input type="hidden" name="bio" id="bioInput" value="{{ profile.bio }}">
          <input type="hidden" name="city" id="cityInput" value="{{ profile.city }}">
          <input type="hidden" name="gender" id="genderInput" value="{{ profile.gender }}">
          <input type="hidden" name="receive_notifications" id="notificationsInput" value="{{ profile.receive_notifications }}">
          <input type="hidden" name="receive_emails" id="emailsInput" value="{{ profile.receive_emails }}">
          
          <button type="button" class="save-btn" onclick="saveSettings()">
            <span>๐พ</span>
            <span>ุญูุธ ุงูุชุบููุฑุงุช</span>
          </button>
        </form>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</div>
        <form method="post" action="{% url 'accounts:profile' %}" id="passwordForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="change_password">
          <div class="modal-body">
            <div class="form-group">
              <label for="currentPassword">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
              <input type="password" name="old_password" id="currentPassword" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ" required />
            </div>
            <div class="form-group">
              <label for="newPassword">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
              <input type="password" name="new_password" id="newPassword" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ" required />
            </div>
            <div class="form-group">
              <label for="confirmPassword">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ</label>
              <input type="password" name="confirm_password" id="confirmPassword" placeholder="ุฃุนุฏ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ" required />
            </div>
          </div>
          <div class="modal-buttons">
            <button type="button" class="cancel-btn" onclick="closePasswordModal()">ุฅูุบุงุก</button>
            <button type="submit" class="success-btn">ุญูุธ ุงูุชุบููุฑุงุช</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Account Modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">โ๏ธ ุญุฐู ุงูุญุณุงุจ</div>
        <div class="modal-body">
          <p>ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุญุฐู ุญุณุงุจูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
          <p style="color: var(--danger); font-weight: bold">
            ุณูุชู ุญุฐู ุฌููุน ุจูุงูุงุชู ูุฅูุฌุงุฒุงุชู ุจุดูู ููุงุฆู!
          </p>
        </div>
        <div class="modal-buttons">
          <button class="cancel-btn" onclick="closeDeleteModal()">ุฅูุบุงุก</button>
          <button class="confirm-btn" onclick="deleteAccount()">ุญุฐู ุงูุญุณุงุจ</button>
        </div>
      </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
      function toggleSection(element) {
        const content = element.nextElementSibling;
        element.classList.toggle("active");
        content.classList.toggle("active");
      }

      function openPasswordModal() {
        document.getElementById("passwordModal").classList.add("active");
      }

      function closePasswordModal() {
        document.getElementById("passwordModal").classList.remove("active");
        document.getElementById("currentPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
      }

      function openDeleteModal() {
        document.getElementById("deleteModal").classList.add("active");
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").classList.remove("active");
      }

      function deleteAccount() {
        if (confirm("ุชุฃููุฏ ููุงุฆู: ุณูุชู ุญุฐู ุฌููุน ุจูุงูุงุชู!")) {
          // Create form and submit
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '{% url "accounts:profile" %}';
          
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrfToken;
          
          const actionInput = document.createElement('input');
          actionInput.type = 'hidden';
          actionInput.name = 'action';
          actionInput.value = 'delete_account';
          
          form.appendChild(csrfInput);
          form.appendChild(actionInput);
          document.body.appendChild(form);
          form.submit();
        }
      }

      function saveSettings() {
        const receiveNotifications = document.getElementById("receiveNotifications").checked;
        const receiveEmails = document.getElementById("receiveEmails").checked;
        
        document.getElementById("notificationsInput").value = receiveNotifications;
        document.getElementById("emailsInput").value = receiveEmails;
        
        // Store preferences in localStorage for non-DB settings
        localStorage.setItem('difficulty', document.getElementById("difficulty").value);
        localStorage.setItem('soundEffects', document.getElementById("soundEffects").checked);
        localStorage.setItem('darkMode', document.getElementById("darkMode").checked);
        localStorage.setItem('profileVisibility', document.getElementById("profileVisibility").value);
        localStorage.setItem('leaderboard', document.getElementById("leaderboard").checked);
        
        document.getElementById("settingsForm").submit();
      }

      window.onclick = function (event) {
        const passwordModal = document.getElementById("passwordModal");
        const deleteModal = document.getElementById("deleteModal");

        if (event.target === passwordModal) {
          closePasswordModal();
        }
        if (event.target === deleteModal) {
          closeDeleteModal();
        }
      };

      window.addEventListener("load", () => {
        const firstSection = document.querySelector(".section-title");
        if (firstSection) {
          firstSection.click();
        }
        
        // Load saved preferences
        const difficulty = localStorage.getItem('difficulty');
        const soundEffects = localStorage.getItem('soundEffects');
        const darkMode = localStorage.getItem('darkMode');
        const profileVisibility = localStorage.getItem('profileVisibility');
        const leaderboard = localStorage.getItem('leaderboard');
        
        if (difficulty) document.getElementById("difficulty").value = difficulty;
        if (soundEffects !== null) document.getElementById("soundEffects").checked = soundEffects === 'true';
        if (darkMode !== null) document.getElementById("darkMode").checked = darkMode === 'true';
        if (profileVisibility) document.getElementById("profileVisibility").value = profileVisibility;
        if (leaderboard !== null) document.getElementById("leaderboard").checked = leaderboard === 'true';
      });

      const darkModeToggle = document.getElementById("darkMode");
      darkModeToggle.addEventListener("change", (e) => {
        if (e.target.checked) {
          document.body.style.backgroundColor = "#1a1a1a";
          document.body.style.color = "#ffffff";
        } else {
          document.body.style.backgroundColor = "#f5f5f5";
          document.body.style.color = "#2e7d32";
        }
      });
    </script>
{% endblock extra_js %}