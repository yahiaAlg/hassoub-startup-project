{% extends "base.html" %}
{% load static %}

{% block title %}Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±{% endblock title %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/accounts/parent-dashboard.css' %}" />
{% endblock extra_css %}

{% block content %}
    <div class="dashboard-container fade-in">
      <!-- Header Section -->
      <div class="parent-header">
        <div class="welcome-message">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {{ user.get_full_name|default:user.username }}! ğŸ‘‹</div>
        <div class="subtitle">
          {% if children_data %}
            Ø±Ø§Ù‚Ø¨ ØªÙ‚Ø¯Ù… Ø£Ø·ÙØ§Ù„Ùƒ ÙˆØ£Ø³Ù†Ø¯ Ù„Ù‡Ù… Ù…Ø­ØªÙˆÙ‰ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¬Ø¯ÙŠØ¯
          {% else %}
            Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£Ø·ÙØ§Ù„ Ø¨Ø¹Ø¯. <a href="#add-child">Ø£Ø¶Ù Ø·ÙÙ„ Ø§Ù„Ø¢Ù†</a>
          {% endif %}
        </div>
        <div class="header-meta">
          {% if children_data|length > 1 %}
          <div class="child-selector">
            <label for="child-select">Ø§Ø®ØªØ± Ø§Ù„Ø·ÙÙ„:</label>
            <select id="child-select" onchange="changeChild(this.value)">
              {% for child_data in children_data %}
              <option value="{{ child_data.child.id }}" {% if forloop.first %}selected{% endif %}>
                {{ child_data.child.get_full_name }} ({{ child_data.profile.age }} Ø³Ù†ÙˆØ§Øª)
              </option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <div class="notifications" onclick="showNotifications()">
            <span class="notification-icon">ğŸ””</span>
            <span class="notification-count">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</span>
          </div>
        </div>
      </div>

      {% if not children_data %}
      <!-- No Children Message -->
      <div class="section" id="add-child">
        <div style="text-align: center; padding: 40px;">
          <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£Ø·ÙØ§Ù„Ùƒ</h3>
          <p>Ø£Ø¶Ù Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø·ÙÙ„Ùƒ Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù…Ù‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</p>
          <form method="post" action="{% url 'accounts:add_child' %}" style="max-width: 400px; margin: 20px auto;">
            {% csrf_token %}
            <input type="text" name="child_username" placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø·ÙÙ„" required 
                   style="padding: 10px; width: 100%; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd;">
            <button type="submit" class="recommend-button" style="width: 100%;">Ø¥Ø¶Ø§ÙØ© Ø·ÙÙ„</button>
          </form>
        </div>
      </div>
      {% else %}

      {% for child_data in children_data %}
      <div class="child-section" data-child-id="{{ child_data.child.id }}" {% if not forloop.first %}style="display: none;"{% endif %}>
        
        <!-- Summary Cards -->
        <div class="summary-cards">
          <div class="summary-card">
            <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            <div class="card-value">{{ child_data.completed_lessons }}</div>
            <div class="card-change positive">Ø¯Ø±ÙˆØ³ Ù…Ù†Ø¬Ø²Ø©</div>
          </div>
          <div class="summary-card">
            <div class="card-title">Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            <div class="card-value">{{ child_data.completed_scenarios }}</div>
            <div class="card-change positive">Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª</div>
          </div>
          <div class="summary-card">
            <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
            <div class="card-value">{{ child_data.total_points }}</div>
            <div class="card-change positive">â­ Ù†Ù‚Ø·Ø©</div>
          </div>
          <div class="summary-card">
            <div class="card-title">Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
            <div class="card-value">{{ child_data.streak.current_streak|default:0 }} Ø£ÙŠØ§Ù…</div>
            <div class="card-change positive">ğŸ”¥ {% if child_data.streak.current_streak > 3 %}Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø¯Ù…!{% else %}ÙŠØ­ØªØ§Ø¬ ØªØ´Ø¬ÙŠØ¹{% endif %}</div>
          </div>
        </div>

        <!-- Content Sections -->
        <div class="content-sections">
          <!-- Learning Progress -->
          <div class="section">
            <h2 class="section-title">ğŸ“š ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ¹Ù„Ù…</h2>
            {% if child_data.recent_lessons %}
            <div style="overflow-x: auto">
              <table class="progress-table">
                <thead>
                  <tr>
                    <th>Ø§Ù„Ø¯Ø±Ø³</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„ØªÙ‚Ø¯Ù…</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user_lesson in child_data.recent_lessons %}
                  <tr>
                    <td>{{ user_lesson.lesson.title_ar }}</td>
                    <td class="{% if user_lesson.is_completed %}status-completed{% else %}status-inprogress{% endif %}">
                      {% if user_lesson.is_completed %}âœ“ Ù…ÙƒØªÙ…Ù„{% else %}â³ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°{% endif %}
                    </td>
                    <td>{{ user_lesson.progress }}%</td>
                    <td>{{ user_lesson.started_at|date:"d/m/Y" }}</td>
                    <td>
                      {% if user_lesson.is_completed %}
                      <button class="review-button" onclick="reviewLesson('{{ user_lesson.lesson.id }}')">
                        Ù…Ø±Ø§Ø¬Ø¹Ø©
                      </button>
                      {% else %}
                      <button class="continue-button" onclick="continueLesson('{{ user_lesson.lesson.id }}')">
                        Ù…ØªØ§Ø¨Ø¹Ø©
                      </button>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p style="text-align: center; padding: 20px; color: #666;">Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø£ÙŠ Ø¯Ø±ÙˆØ³ Ø¨Ø¹Ø¯</p>
            {% endif %}
          </div>

          <!-- Recent Achievements -->
          {% if child_data.recent_achievements %}
          <div class="section">
            <h2 class="section-title">ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h2>
            <div class="skills-grid">
              {% for user_achievement in child_data.recent_achievements %}
              <div class="skill-card">
                <div class="skill-name">
                  {{ user_achievement.achievement.icon }} {{ user_achievement.achievement.name_ar }}
                </div>
                <div class="progress-percentage">
                  {{ user_achievement.earned_at|date:"d/m/Y" }}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Child Stats -->
          <div class="section">
            <h2 class="section-title">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·ÙÙ„</h2>
            <div class="reports-section">
              <div class="report-card">
                <div class="report-icon">ğŸ“ˆ</div>
                <div class="report-title">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: {{ child_data.profile.level }}</div>
              </div>
              <div class="report-card">
                <div class="report-icon">ğŸ’°</div>
                <div class="report-title">Ø§Ù„Ø¹Ù…Ù„Ø§Øª: {{ child_data.profile.coins }}</div>
              </div>
              <div class="report-card">
                <div class="report-icon">ğŸ“</div>
                <div class="report-title">Ø´Ù‡Ø§Ø¯Ø§Øª: {{ child_data.certificates }}</div>
              </div>
              <div class="report-card">
                <div class="report-icon">ğŸ”¥</div>
                <div class="report-title">Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø©: {{ child_data.streak.longest_streak|default:0 }} ÙŠÙˆÙ…</div>
              </div>
            </div>
          </div>

          <!-- Remove Child -->
          <div class="section">
            <h2 class="section-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            <form method="post" action="{% url 'accounts:remove_child' child_data.child.id %}" 
                  onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© {{ child_data.child.get_full_name }} Ù…Ù† Ù‚Ø§Ø¦Ù…ØªÙƒØŸ');">
              {% csrf_token %}
              <button type="submit" class="delete-account-btn" style="margin: 20px 0;">
                Ø¥Ø²Ø§Ù„Ø© {{ child_data.child.get_full_name }} Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
              </button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
      {% endif %}
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
      function changeChild(childId) {
        document.querySelectorAll('.child-section').forEach(section => {
          section.style.display = 'none';
        });
        document.querySelector(`[data-child-id="${childId}"]`).style.display = 'block';
        
        // Animate new section
        const sections = document.querySelectorAll('.summary-card');
        sections.forEach((card, index) => {
          card.style.opacity = "0";
          card.style.transform = "translateY(20px)";
          setTimeout(() => {
            card.style.transition = "all 0.5s ease";
            card.style.opacity = "1";
            card.style.transform = "translateY(0)";
          }, 100 * index);
        });
      }

      function showNotifications() {
        alert('Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...');
      }

      function reviewLesson(lessonId) {
        window.location.href = `/lessons/lesson/${lessonId}/`;
      }

      function continueLesson(lessonId) {
        alert('Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ù„Ù„Ø·ÙÙ„ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³.');
      }

      function assignLesson(lessonId) {
        const confirmed = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø³Ù†Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ');
        if (confirmed) {
          alert('âœ… ØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­!');
        }
      }

      function viewReport(reportType) {
        const reportNames = {
          progress: "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚Ø¯Ù…",
          activity: "Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·",
          skill: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª",
          peer: "Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ù‚Ø±Ø§Ù†",
        };
        alert(`Ø¹Ø±Ø¶ ${reportNames[reportType]}...\n\nÙ‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±.`);
      }

      function assignContent(contentId) {
        const confirmed = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø³Ù†Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ');
        if (confirmed) {
          alert('âœ… ØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­!');
        }
      }

      window.addEventListener("load", () => {
        const progressBars = document.querySelectorAll(".progress-bar-fill");
        progressBars.forEach((bar) => {
          const targetWidth = bar.style.width;
          bar.style.width = "0%";
          setTimeout(() => {
            bar.style.width = targetWidth;
          }, 300);
        });

        const summaryCards = document.querySelectorAll(".summary-card");
        summaryCards.forEach((card, index) => {
          card.style.opacity = "0";
          card.style.transform = "translateY(20px)";
          setTimeout(() => {
            card.style.transition = "all 0.5s ease";
            card.style.opacity = "1";
            card.style.transform = "translateY(0)";
          }, 100 * index);
        });
      });

      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute("href"));
          if (target) {
            target.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        });
      });

      console.log(
        "%c Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±! ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",
        "color: #4caf50; font-size: 20px; font-weight: bold;"
      );
    </script>
{% endblock extra_js %}