{% extends "base.html" %}
{% load static %}
{% load math_filters %}
{% block title %}
Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
{% endblock title %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/accounts/dashboard.css' %}" />
{% endblock extra_css %}
{% block content %}

    <div class="dashboard-container">
      <!-- Header Section -->
      <div class="header">
        <div class="welcome-message">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒØŒ {{ request.user.first_name|default:request.user.username }}! ğŸ‘‹</div>
        <div class="notifications">
          ğŸ””
          <span class="notification-badge">3</span>
        </div>
      </div>

      <!-- Stats Container -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
          <div class="stat-value">{{ total_points }}</div>
          <div class="stat-change positive">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {{ profile.level }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
          <div class="stat-value">{{ total_lessons }}</div>
          <div class="stat-change positive">{{ recent_lessons|length }} Ù†Ø´Ø·Ø©</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div>
          <div class="stat-value">{{ total_scenarios }}</div>
          <div class="stat-change positive">{{ certificates.count }} Ø´Ù‡Ø§Ø¯Ø©</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ù†ÙŠØ©</div>
          <div class="stat-value">{{ total_coins }} ğŸª™</div>
          <div class="stat-change positive">Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¥Ù†ÙØ§Ù‚</div>
        </div>
      </div>

      <!-- Progress Section -->
      <div class="progress-section">
        <div class="progress-card">
          <div class="progress-title">ğŸ“ˆ ØªÙ‚Ø¯Ù…Ùƒ</div>
          <div class="level-display">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {{ profile.level }}</div>
          <div class="level-info">
            <span>{{ profile.total_points }} Ù†Ù‚Ø·Ø© Ø®Ø¨Ø±Ø©</span>
            <span>{% if profile.level == 1 %}100{% elif profile.level == 2 %}300{% elif profile.level == 3 %}600{% elif profile.level == 4 %}1000{% else %}{{ profile.level|add:"-4"|multiply:500|add:1000 }}{% endif %} Ù†Ù‚Ø·Ø© Ø®Ø¨Ø±Ø©</span>
          </div>
          <div class="xp-bar">
            <div class="xp-fill" style="width: {{ profile.get_progress_to_next_level }}%;"></div>
          </div>
          <div class="milestone">
            <div class="milestone-title">ğŸ¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„ØªØ§Ù„ÙŠ</div>
            <div class="milestone-info">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {{ profile.level|add:1 }}: Ù‚Ø·Ø¨ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
            <div class="milestone-info">
              {% if profile.level == 1 %}{{ 100|subtract:profile.total_points }}
              {% elif profile.level == 2 %}{{ 300|subtract:profile.total_points }}
              {% elif profile.level == 3 %}{{ 600|subtract:profile.total_points }}
              {% elif profile.level == 4 %}{{ 1000|subtract:profile.total_points }}
              {% else %}{{ profile.level|add:"-4"|multiply:500|add:1000|subtract:profile.total_points }}
              {% endif %} Ù†Ù‚Ø·Ø© Ø®Ø¨Ø±Ø© Ù…ØªØ¨Ù‚ÙŠØ©
            </div>
            <div class="milestone-info" style="margin-top: 8px; color: var(--primary)">
              ğŸ”“ ÙØªØ­: Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
            </div>
          </div>
        </div>

        <div class="progress-card">
          <div class="progress-title">ğŸ”¥ Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
          <div class="streak-counter">
            <div class="streak-display">
              <span class="fire-icon">ğŸ”¥</span>
              <span class="streak-number">{{ streak.current_streak|default:0 }}</span>
            </div>
            <div class="streak-label">Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©</div>
          </div>
          <div style="margin-top: 20px; padding: 15px; background-color: #fff3e0; border-radius: 10px; text-align: center;">
            <p style="color: var(--accent); font-weight: bold; margin-bottom: 5px;">
              Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø¯Ù…! ğŸ’ª
            </p>
            <p style="color: var(--text-light); font-size: 0.9em">
              {% if streak.current_streak %}
                {% if streak.current_streak < 10 %}
                  {{ 10|subtract:streak.current_streak }} Ø£ÙŠØ§Ù… Ø£Ø®Ø±Ù‰ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø© 10 Ø£ÙŠØ§Ù…!
                {% else %}
                  Ø£Ø­Ø³Ù†Øª! Ù„Ø¯ÙŠÙƒ Ø³Ù„Ø³Ù„Ø© Ø±Ø§Ø¦Ø¹Ø©!
                {% endif %}
              {% else %}
                Ø§Ø¨Ø¯Ø£ Ø³Ù„Ø³Ù„ØªÙƒ Ø§Ù„ÙŠÙˆÙ…!
              {% endif %}
            </p>
          </div>
        </div>
      </div>

      <!-- Recommendations -->
      <div class="recommendations">
        <div class="recommendations-title">ğŸ’¡ ØªÙˆØµÙŠØ§Øª Ù…Ø®ØµØµØ© Ù„Ùƒ</div>
        <div class="recommendations-grid">
          <div class="recommendation-card">
            <div class="recommendation-icon">ğŸª</div>
            <div class="recommendation-title">Ù…ØªØ¬Ø± Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„ÙƒØ¨ÙŠØ±</div>
            <div class="recommendation-description">
              Ù„Ù‚Ø¯ Ø£ØªÙ‚Ù†Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª! Ø¬Ø±Ø¨ Ø¥Ø¯Ø§Ø±Ø© Ù…ØªØ¬Ø± Ø£Ù„Ø¹Ø§Ø¨ Ù…Ø¹ Ø®Ø·ÙˆØ· Ø¥Ù†ØªØ§Ø¬ Ù…ØªØ¹Ø¯Ø¯Ø© ÙˆØ·Ù„Ø¨ Ù…ÙˆØ³Ù…ÙŠ.
            </div>
            <button class="start-button" onclick="startScenario('toy-shop')">
              <span>â–¶ï¸</span>
              <span>Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ</span>
            </button>
          </div>
          <div class="recommendation-card">
            <div class="recommendation-icon">ğŸ‹</div>
            <div class="recommendation-title">Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ù„ÙŠÙ…ÙˆÙ†</div>
            <div class="recommendation-description">
              ØªØ¯Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ± Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ. Ù…Ø«Ø§Ù„ÙŠ Ù„Ø¬Ù„Ø³Ø© Ø³Ø±ÙŠØ¹Ø© Ù…Ø¯ØªÙ‡Ø§ 10 Ø¯Ù‚Ø§Ø¦Ù‚!
            </div>
            <button class="start-button" onclick="startScenario('lemonade')">
              <span>â–¶ï¸</span>
              <span>Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ</span>
            </button>
          </div>
          <div class="recommendation-card">
            <div class="recommendation-icon">ğŸ“Š</div>
            <div class="recommendation-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
            <div class="recommendation-description">
              ØªØ¹Ù„Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ© ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®Ù„ Ù…Ù† Ø®Ù„Ø§Ù„ ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©.
            </div>
            <button class="start-button" onclick="startLesson('financial-reports')">
              <span>ğŸ“š</span>
              <span>Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø³</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Badges Section -->
      <div class="badges-section">
        <div class="badges-title">ğŸ† Ø´Ø§Ø±Ø§ØªÙƒ</div>
        <div class="badges-grid">
          {% for achievement in recent_achievements %}
            <div class="badge">
              <div class="badge-icon">{{ achievement.achievement.icon }}</div>
              <div class="badge-name">{{ achievement.achievement.name_ar }}</div>
            </div>
          {% endfor %}
          
          <!-- Locked badges placeholder -->
          {% if recent_achievements|length < 6 %}
            {% if recent_achievements|length <= 5 %}
              <div class="badge locked">
                <span class="lock-icon">ğŸ”’</span>
                <div class="badge-icon">ğŸ†</div>
                <div class="badge-name">Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
              </div>
            {% endif %}
            {% if recent_achievements|length <= 4 %}
              <div class="badge locked">
                <span class="lock-icon">ğŸ”’</span>
                <div class="badge-icon">ğŸ†</div>
                <div class="badge-name">Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
              </div>
            {% endif %}
            {% if recent_achievements|length <= 3 %}
              <div class="badge locked">
                <span class="lock-icon">ğŸ”’</span>
                <div class="badge-icon">ğŸ†</div>
                <div class="badge-name">Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
              </div>
            {% endif %}
            {% if recent_achievements|length <= 2 %}
              <div class="badge locked">
                <span class="lock-icon">ğŸ”’</span>
                <div class="badge-icon">ğŸ†</div>
                <div class="badge-name">Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
              </div>
            {% endif %}
            {% if recent_achievements|length <= 1 %}
              <div class="badge locked">
                <span class="lock-icon">ğŸ”’</span>
                <div class="badge-icon">ğŸ†</div>
                <div class="badge-name">Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
              </div>
            {% endif %}
            {% if recent_achievements|length == 0 %}
              <div class="badge locked">
                <span class="lock-icon">ğŸ”’</span>
                <div class="badge-icon">ğŸ†</div>
                <div class="badge-name">Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="recent-activity">
        <div class="activity-title">ğŸ“œ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø®ÙŠØ±</div>
        <div class="activity-list">
          {% for lesson in recent_lessons %}
            <div class="activity-item">
              <div class="activity-icon">{% if lesson.is_completed %}âœ…{% else %}ğŸ“–{% endif %}</div>
              <div class="activity-content">
                {% if lesson.is_completed %}Ø£ÙƒÙ…Ù„Øª{% else %}Ø¨Ø¯Ø£Øª{% endif %} Ø¯Ø±Ø³ "{{ lesson.lesson.title_ar }}"
              </div>
              <div class="activity-time">{{ lesson.started_at|timesince }} Ù…Ø¶Øª</div>
            </div>
          {% endfor %}
          
          {% for scenario in recent_scenarios %}
            <div class="activity-item">
              <div class="activity-icon">{% if scenario.status == 'completed' %}ğŸ®{% else %}â³{% endif %}</div>
              <div class="activity-content">
                {% if scenario.status == 'completed' %}Ø£ÙƒÙ…Ù„Øª{% else %}Ø¨Ø¯Ø£Øª{% endif %} Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ "{{ scenario.scenario.title_ar }}"
              </div>
              <div class="activity-time">{{ scenario.started_at|timesince }} Ù…Ø¶Øª</div>
            </div>
          {% endfor %}
          
          {% if not recent_lessons and not recent_scenarios %}
            <div class="activity-item">
              <div class="activity-icon">ğŸ¯</div>
              <div class="activity-content">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ø¢Ù†!</div>
              <div class="activity-time">Ø§Ù„Ø¢Ù†</div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <div class="action-card" onclick="window.location.href='{% url "lessons:learning_path" %}'">
          <div class="action-icon">ğŸ®</div>
          <div class="action-title">Ø¨Ø¯Ø¡ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø¬Ø¯ÙŠØ¯</div>
        </div>
        <div class="action-card" onclick="window.location.href='{% url "accounts:profile" %}'">
          <div class="action-icon">ğŸ‘¤</div>
          <div class="action-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
        </div>
        <div class="action-card" onclick="window.location.href='{% url "accounts:progress_rewards" %}'">
          <div class="action-icon">ğŸ†</div>
          <div class="action-title">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</div>
        </div>
        <div class="action-card" onclick="visitShop()">
          <div class="action-icon">ğŸ›’</div>
          <div class="action-title">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±</div>
        </div>
      </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
      // Scenario functions
      function startScenario(scenarioId) {
        window.location.href = "{% url 'lessons:learning_path' %}";
      }

      function startLesson(lessonId) {
        window.location.href = "{% url 'lessons:learning_path' %}";
      }

      function visitShop() {
        alert("Ø§Ù„Ù…ØªØ¬Ø± Ù‚Ø±ÙŠØ¨Ø§Ù‹! ğŸ›’");
      }

      // Notification click handler
      document.querySelector(".notifications").addEventListener("click", function () {
        alert("Ù„Ø¯ÙŠÙƒ 3 Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©:\n\n1. Ø£Ø­Ù…Ø¯ ØªØ­Ø¯Ø§Ùƒ ÙÙŠ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø¬Ø¯ÙŠØ¯!\n2. ÙØªØ­Øª Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ†\n3. Ø¹Ø±Ø¶ Ø®Ø§Øµ: Ø®ØµÙ… 20% Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ!");
      });

      // Add smooth scroll behavior
      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute("href"));
          if (target) {
            target.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        });
      });

      // Animate stats on page load
      window.addEventListener("load", () => {
        const statValues = document.querySelectorAll(".stat-value");
        statValues.forEach((stat) => {
          stat.style.transform = "scale(0)";
          setTimeout(() => {
            stat.style.transition = "transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)";
            stat.style.transform = "scale(1)";
          }, 100);
        });
      });

      // Add hover effects to cards
      const cards = document.querySelectorAll(".stat-card, .recommendation-card, .action-card, .badge");
      cards.forEach((card) => {
        card.addEventListener("mouseenter", function () {
          this.style.transition = "all 0.3s ease";
        });
      });

      // Console welcome message
      console.log("%c Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„ØµØºÙŠØ±! ğŸ’°", "color: #4caf50; font-size: 20px; font-weight: bold;");
      console.log("%c Ø§Ø³ØªÙ…ØªØ¹ Ø¨ØªØ¹Ù„Ù… Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©! ğŸš€", "color: #ff9800; font-size: 14px;");
    </script>
{% endblock extra_js %}