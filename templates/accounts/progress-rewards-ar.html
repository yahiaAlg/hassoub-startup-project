{% extends "base.html" %}
{% load static %}

{% block title %}
ุชูุฏูู ูุฅูุฌุงุฒุงุชู
{% endblock title %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/accounts/progress-rewards-ar.css' %}" />
{% endblock extra_css %}

{% block content %}
    <!-- Main Container -->
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>ุชูุฏูู ูุฅูุฌุงุฒุงุชู</h1>
        <p>
          ุชุชุจุน ุฑุญูุฉ ุชุนูููุ ุงุญุชูู ุจุฅูุฌุงุฒุงุชูุ ูุงูุชุดู ูุง ููุชุธุฑู ูู ูุบุงูุฑุฉ ุงูุชุนููู ุงููุงูู ุงูุฎุงุตุฉ ุจู!
        </p>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Statistics Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">โญ</div>
            <div class="stat-value">ุงููุณุชูู {{ profile.level }}</div>
            <div class="stat-label">ุงููุณุชูู ุงูุญุงูู</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">๐ฏ</div>
            <div class="stat-value">{{ profile.total_points }}</div>
            <div class="stat-label">ููุงุท ุงูุฎุจุฑุฉ</div>
            <div class="stat-sublabel">{{ next_level_points }} ูููุณุชูู ุงูุชุงูู</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">๐ช</div>
            <div class="stat-value">{{ profile.coins }}</div>
            <div class="stat-label">ุงูุนููุงุช ุงูููุชุณุจุฉ</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">๐</div>
            <div class="stat-value">{{ achievements_data|length }}</div>
            <div class="stat-label">ุงูุดุงุฑุงุช ุงูููุชุณุจุฉ</div>
          </div>
        </div>

        <!-- Level Progress Bar -->
        <div class="progress-section">
          <h2 class="section-title">๐ ุชูุฏู ุงููุณุชูู</h2>
          <div class="level-progress-container">
            <div class="level-info">
              <div class="current-level">
                <span class="level-badge">ุงููุณุชูู {{ profile.level }}</span>
                <span class="level-points">{{ profile.total_points }} ููุทุฉ</span>
              </div>
              <div class="next-level">
                <span class="level-badge next">ุงููุณุชูู {{ profile.level|add:1 }}</span>
                <span class="level-points">{{ next_level_points }} ููุทุฉ</span>
              </div>
            </div>
            <div class="level-progress-bar">
              <div class="level-progress-fill" style="width: {{ progress_percentage }}%">
                <span class="progress-text">{{ progress_percentage }}%</span>
              </div>
            </div>
            <p class="progress-hint">
              {{ next_level_points|add:"-"|add:profile.total_points }} ููุทุฉ ูุชุจููุฉ ูููุตูู ุฅูู ุงููุณุชูู ุงูุชุงูู
            </p>
          </div>
        </div>

        <!-- Daily Streak -->
        {% if streak %}
        <div class="progress-section">
          <h2 class="section-title">๐ฅ ุณูุณูุฉ ุงูุฃูุงู ุงููุชุชุงููุฉ</h2>
          <div class="streak-container">
            <div class="streak-card">
              <div class="streak-icon">๐ฅ</div>
              <div class="streak-info">
                <div class="streak-value">{{ streak.current_streak }} ููู</div>
                <div class="streak-label">ุงูุณูุณูุฉ ุงูุญุงููุฉ</div>
              </div>
            </div>
            <div class="streak-card">
              <div class="streak-icon">๐</div>
              <div class="streak-info">
                <div class="streak-value">{{ streak.longest_streak }} ููู</div>
                <div class="streak-label">ุฃุทูู ุณูุณูุฉ</div>
              </div>
            </div>
            <div class="streak-message">
              {% if streak.current_streak >= 7 %}
                <p>๐ ุฑุงุฆุน! ููุฏ ุญุงูุธุช ุนูู ุณูุณูุชู ูุฃูุซุฑ ูู ุฃุณุจูุน!</p>
              {% elif streak.current_streak >= 3 %}
                <p>๐ ุงุณุชูุฑ! ุฃูุช ุชุจูู ุนุงุฏุฉ ุฑุงุฆุนุฉ!</p>
              {% else %}
                <p>๐ช ุงุจุฏุฃ ุณูุณูุชู ุงูููู! ุณุฌู ุงูุฏุฎูู ููููุงู ููุญูุงุธ ุนูููุง.</p>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Badges/Achievements Section -->
        <h2 class="section-title">๐ ุฅูุฌุงุฒุงุชู ูุดุงุฑุงุชู</h2>
        
        <!-- Statistics Summary -->
        <div class="stats-summary">
          {% with earned_count=achievements_data|length total_count=achievements_data|length %}
          <div class="stat-card">
            <div class="stat-icon">๐</div>
            <div class="stat-value">
              {% for item in achievements_data %}
                {% if item.is_earned %}{{ forloop.counter0 }}{% endif %}
              {% endfor %}
            </div>
            <div class="stat-label">ุงูุดุงุฑุงุช ุงูููุชุณุจุฉ</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">๐ฏ</div>
            <div class="stat-value">{{ achievements_data|length }}</div>
            <div class="stat-label">ุฅุฌูุงูู ุงููุชุงุญ</div>
          </div>
          {% endwith %}
          <div class="stat-card">
            <div class="stat-icon">โญ</div>
            <div class="stat-value">
              {% for item in recent_achievements %}
                {{ item.achievement.points_reward }}
              {% endfor %}
            </div>
            <div class="stat-label">XP ูู ุงูุดุงุฑุงุช</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">๐ฅ</div>
            <div class="stat-value">
              {% for item in achievements_data %}
                {% if not item.is_earned %}{{ forloop.counter0 }}{% endif %}
              {% endfor %}
            </div>
            <div class="stat-label">ูุฑูุจุงู ุฌุฏุงู!</div>
          </div>
        </div>

        <!-- Category Tabs -->
        <div class="category-tabs">
          <div class="tab active" data-category="all">ุงููู</div>
          <div class="tab" data-category="earned">ุงูููุชุณุจุฉ</div>
          <div class="tab" data-category="locked">ููููุฉ</div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
          <input type="text" class="search-box" placeholder="ุงุจุญุซ ุนู ุดุงุฑุฉ..." />
          <div class="sort-options">
            <label for="sort-select">ุงูุชุฑุชูุจ ุญุณุจ:</label>
            <select id="sort-select">
              <option value="recent">ุงูุฃุญุฏุซ</option>
              <option value="name">ุงูุงุณู</option>
              <option value="type">ุงูููุน</option>
            </select>
          </div>
        </div>

        <!-- Badges Grid -->
        <div class="badges-container">
          {% regroup achievements_data by achievement.get_achievement_type_display as achievement_groups %}
          
          {% for group in achievement_groups %}
          <div class="category-section">
            <div class="category-header">
              <h3 class="category-title">{{ group.grouper }}</h3>
              <span class="category-count">
                {% with earned=group.list|length %}
                  {{ earned }} ุดุงุฑุฉ ูุชุงุญุฉ
                {% endwith %}
              </span>
            </div>
            
            <div class="badges-grid">
              {% for item in group.list %}
              <div class="badge-card {% if item.is_earned %}earned{% else %}locked{% endif %}" 
                   data-achievement-id="{{ item.achievement.id }}"
                   onclick="showBadgeModal(
                     '{{ item.achievement.icon }}', 
                     '{{ item.achievement.name }}', 
                     '{{ item.achievement.description }}', 
                     '{% if item.is_earned %}earned{% else %}locked{% endif %}',
                     {{ item.achievement.points_required }},
                     {{ item.achievement.points_reward }},
                     {{ item.achievement.coins_reward }}
                   )">
                <div class="badge-icon {% if item.is_earned %}earned{% else %}locked{% endif %}">
                  {% if item.is_earned %}
                    {{ item.achievement.icon }}
                  {% else %}
                    <span class="badge-lock">๐</span>
                  {% endif %}
                </div>
                <div class="badge-title">{{ item.achievement.name }}</div>
                <div class="badge-description">{{ item.achievement.description }}</div>
                {% if item.is_earned %}
                <div class="badge-earned-mark">โ ููุชุณุจุฉ</div>
                {% else %}
                <div class="badge-requirements">
                  {{ item.achievement.points_required }} ููุทุฉ ูุทููุจุฉ
                </div>
                {% endif %}
                <div class="badge-rewards">
                  <span>+{{ item.achievement.points_reward }} XP</span>
                  <span>+{{ item.achievement.coins_reward }} ๐ช</span>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Recent Activity -->
        <div class="progress-section">
          <h2 class="section-title">๐ ุงููุดุงุท ุงูุฃุฎูุฑ</h2>
          <ul class="recent-activity">
            {% for achievement in recent_achievements %}
            <li class="activity-item">
              <div class="activity-icon">{{ achievement.achievement.icon }}</div>
              <div class="activity-content">
                <div class="activity-title">ุญุตูุช ุนูู ุดุงุฑุฉ "{{ achievement.achievement.name }}"</div>
                <div class="activity-meta">
                  +{{ achievement.achievement.points_reward }} ููุทุฉุ +{{ achievement.achievement.coins_reward }} ุนููุฉ
                </div>
              </div>
              <div class="activity-time">{{ achievement.earned_at|timesince }} ูุถุช</div>
            </li>
            {% empty %}
            <li class="activity-item">
              <div class="activity-icon">๐</div>
              <div class="activity-content">
                <div class="activity-title">ุงุจุฏุฃ ุฑุญูุชู ุงูุชุนููููุฉ</div>
                <div class="activity-meta">ูุง ุชูุฌุฏ ุฅูุฌุงุฒุงุช ุญุชู ุงูุขู</div>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Motivation Quote -->
        <div class="motivation-quote">
          <div class="quote-text">
            "ุงููุฌุงุญ ูู ูุฌููุน ุงูุฌููุฏ ุงูุตุบูุฑุฉ ุงููุชูุฑุฑุฉ ูููุงู ุจุนุฏ ููู."
          </div>
          <div class="quote-author">โ ุฑูุจุฑุช ูููููุฑ</div>
        </div>

        <!-- Achievement Tips -->
        <div class="progress-section">
          <h2 class="section-title">๐ก ูุตุงุฆุญ ููุณุจ ุงููุฒูุฏ ูู ุงูุดุงุฑุงุช</h2>
          <div class="tips-container">
            <div class="tip-card">
              <div class="tip-icon">๐</div>
              <div class="tip-title">ุฃููู ุงูุฏุฑูุณ</div>
              <div class="tip-description">ุฃููู ุงูุฏุฑูุณ ูู ูุณุงุฑุงุช ุงูุชุนูู ุงููุฎุชููุฉ ููุณุจ ุดุงุฑุงุช ุงูุฅููุงู</div>
            </div>
            <div class="tip-card">
              <div class="tip-icon">๐ฏ</div>
              <div class="tip-title">ุงุญุตู ุนูู ุฏุฑุฌุงุช ุนุงููุฉ</div>
              <div class="tip-description">ุงุฌุชุงุฒ ุงูุงุฎุชุจุงุฑุงุช ุจุฏุฑุฌุฉ 100% ููุณุจ ุดุงุฑุงุช ุงูุชููุฒ</div>
            </div>
            <div class="tip-card">
              <div class="tip-icon">๐ฅ</div>
              <div class="tip-title">ุญุงูุธ ุนูู ุงูุณูุณูุฉ</div>
              <div class="tip-description">ุณุฌู ุงูุฏุฎูู ููููุงู ูุญุงูุธ ุนูู ุณูุณูุชู ููุณุจ ุดุงุฑุงุช ุงููุซุงุจุฑุฉ</div>
            </div>
            <div class="tip-card">
              <div class="tip-icon">๐ฎ</div>
              <div class="tip-title">ุฌุฑุจ ุงูุณููุงุฑูููุงุช</div>
              <div class="tip-description">ุฃููู ุงูุณููุงุฑูููุงุช ุงูุชูุงุนููุฉ ููุณุจ ุดุงุฑุงุช ุฎุงุตุฉ</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="badgeModal">
      <div class="modal">
        <span class="modal-close" onclick="closeBadgeModal()">ร</span>
        <div class="modal-icon" id="modalIcon">๐</div>
        <h2 class="modal-title" id="modalTitle">ุดุงุฑุฉ ุงูุฅูุฌุงุฒ</h2>
        <p class="modal-description" id="modalDescription">
          ูุตู ุงูุดุงุฑุฉ ูุธูุฑ ููุง
        </p>
        <div class="modal-details">
          <div class="detail-item">
            <span class="detail-label">ุงูููุงุท ุงููุทููุจุฉ</span>
            <span class="detail-value" id="modalRequirements">0 ููุทุฉ</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ููุงูุฃุฉ ุงูููุงุท</span>
            <span class="detail-value" id="modalPointsReward">+0 XP</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ููุงูุฃุฉ ุงูุนููุงุช</span>
            <span class="detail-value" id="modalCoinsReward">+0 ๐ช</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ุงูุญุงูุฉ</span>
            <span class="detail-value" id="modalStatus">ููููุฉ</span>
          </div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeBadgeModal()">ุฅุบูุงู</button>
        </div>
      </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
      // Animate progress bars on load
      window.addEventListener("load", function () {
        const progressBars = document.querySelectorAll(".level-progress-fill");
        progressBars.forEach((bar) => {
          const width = bar.style.width;
          bar.style.width = "0%";
          setTimeout(() => {
            bar.style.width = width;
          }, 100);
        });

        // Animate badges on scroll
        const observerOptions = {
          threshold: 0.1,
          rootMargin: "0px 0px -50px 0px",
        };

        const observer = new IntersectionObserver(function (entries) {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.style.animation = "fadeInUp 0.5s ease-out";
            }
          });
        }, observerOptions);

        document.querySelectorAll(".badge-card").forEach((badge) => {
          observer.observe(badge);
        });
      });

      // Badge Modal Functions
      function showBadgeModal(icon, title, description, status, pointsRequired, pointsReward, coinsReward) {
        const modal = document.getElementById("badgeModal");
        const modalIcon = document.getElementById("modalIcon");
        const modalTitle = document.getElementById("modalTitle");
        const modalDescription = document.getElementById("modalDescription");
        const modalRequirements = document.getElementById("modalRequirements");
        const modalPointsReward = document.getElementById("modalPointsReward");
        const modalCoinsReward = document.getElementById("modalCoinsReward");
        const modalStatus = document.getElementById("modalStatus");

        modalIcon.textContent = status === "earned" ? icon : "๐";
        modalTitle.textContent = title;
        modalDescription.textContent = description;
        modalRequirements.textContent = pointsRequired + " ููุทุฉ";
        modalPointsReward.textContent = "+" + pointsReward + " XP";
        modalCoinsReward.textContent = "+" + coinsReward + " ๐ช";

        if (status === "earned") {
          modalIcon.style.background = "linear-gradient(135deg, var(--primary), var(--primary-dark))";
          modalStatus.textContent = "โ ููุชุณุจุฉ";
          modalStatus.style.color = "var(--primary)";
        } else {
          modalIcon.style.background = "#ccc";
          modalStatus.textContent = "๐ ููููุฉ";
          modalStatus.style.color = "#999";
        }

        modal.classList.add("show");
      }

      function closeBadgeModal() {
        document.getElementById("badgeModal").classList.remove("show");
      }

      // Close modal when clicking outside
      document.getElementById("badgeModal").addEventListener("click", function (e) {
        if (e.target === this) closeBadgeModal();
      });

      // Tab Filtering
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", function () {
          document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
          this.classList.add("active");

          const category = this.getAttribute("data-category");
          const badges = document.querySelectorAll(".badge-card");

          badges.forEach((badge) => {
            if (category === "all") {
              badge.style.display = "block";
            } else if (category === "earned" && badge.classList.contains("earned")) {
              badge.style.display = "block";
            } else if (category === "locked" && badge.classList.contains("locked")) {
              badge.style.display = "block";
            } else {
              badge.style.display = "none";
            }
          });
        });
      });

      // Search Functionality
      document.querySelector(".search-box").addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll(".badge-card").forEach((badge) => {
          const title = badge.querySelector(".badge-title").textContent.toLowerCase();
          const description = badge.querySelector(".badge-description").textContent.toLowerCase();
          badge.style.display = (title.includes(searchTerm) || description.includes(searchTerm)) ? "block" : "none";
        });
      });

      // Sort Functionality
      document.getElementById("sort-select").addEventListener("change", function(e) {
        const sortBy = e.target.value;
        const container = document.querySelector(".badges-container");
        const sections = Array.from(container.querySelectorAll(".category-section"));
        
        if (sortBy === "name") {
          sections.forEach(section => {
            const grid = section.querySelector(".badges-grid");
            const badges = Array.from(grid.querySelectorAll(".badge-card"));
            badges.sort((a, b) => {
              const titleA = a.querySelector(".badge-title").textContent;
              const titleB = b.querySelector(".badge-title").textContent;
              return titleA.localeCompare(titleB, 'ar');
            });
            badges.forEach(badge => grid.appendChild(badge));
          });
        }
      });
    </script>
{% endblock extra_js %}