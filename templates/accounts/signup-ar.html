{% extends "base.html" %}
{% load static %}

{% block title %}ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/accounts/signup.css' %}" />
{% endblock %}

{% block content %}
<div class="signup-container">
  <div class="form-section">
    <div class="progress-bar">
      <div class="progress-step active">1</div>
      <div class="progress-step">2</div>
      <div class="progress-step">3</div>
    </div>

    <h1>ุฅูุดุงุก ุญุณุงุจู</h1>
    <p class="subtitle">ุงูุถู ุฅูู ูุบุงูุฑุฉ ุงููุงู!</p>

    {% include 'partials/_alerts.html' %}

    <form method="post" action="{% url 'accounts:register' %}" id="signupForm" enctype="multipart/form-data">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="first_name">ุงูุงุณู ุงูุฃูู</label>
        <input
          type="text"
          id="first_name"
          name="first_name"
          required
          placeholder="ุฃุฏุฎู ุงูุงุณู ุงูุฃูู"
          autocomplete="given-name"
          value="{{ request.POST.first_name|default:'' }}"
        />
        <span class="input-icon" id="firstNameIcon">๐ค</span>
      </div>

      <div class="form-group">
        <label for="last_name">ุงูุงุณู ุงูุฃุฎูุฑ</label>
        <input
          type="text"
          id="last_name"
          name="last_name"
          required
          placeholder="ุฃุฏุฎู ุงูุงุณู ุงูุฃุฎูุฑ"
          autocomplete="family-name"
          value="{{ request.POST.last_name|default:'' }}"
        />
        <span class="input-icon" id="lastNameIcon">๐ค</span>
      </div>

      <div class="form-group">
        <label for="username">ุงุณู ุงููุณุชุฎุฏู</label>
        <input
          type="text"
          id="username"
          name="username"
          required
          placeholder="ุงุฎุชุฑ ุงุณู ูุณุชุฎุฏู ูุฑูุฏ"
          autocomplete="username"
          value="{{ request.POST.username|default:'' }}"
        />
        <span class="input-icon" id="usernameIcon">@</span>
        <div class="error-message" id="usernameError">
          ุงุณู ุงููุณุชุฎุฏู ูุฌุจ ุฃู ูููู 3 ุฃุญุฑู ุนูู ุงูุฃูู
        </div>
      </div>

      <div class="form-group">
        <label for="email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
        <input
          type="email"
          id="email"
          name="email"
          required
          placeholder="example@email.com"
          autocomplete="email"
          value="{{ request.POST.email|default:'' }}"
        />
        <span class="input-icon" id="emailIcon">โ๏ธ</span>
        <div class="error-message" id="emailError">
          ุงูุฑุฌุงุก ุฅุฏุฎุงู ุจุฑูุฏ ุฅููุชุฑููู ุตุญูุญ
        </div>
      </div>

      <div class="form-group">
        <label for="age">ุงูุนูุฑ/ุงููุณุชูู ุงูุฏุฑุงุณู</label>
        <select id="age" name="age" required>
          <option value="">ุงุฎุชุฑ ุงูุนูุฑ</option>
          <option value="5" {% if request.POST.age == "5" %}selected{% endif %}>5 ุณููุงุช</option>
          <option value="6" {% if request.POST.age == "6" %}selected{% endif %}>6 ุณููุงุช</option>
          <option value="7" {% if request.POST.age == "7" %}selected{% endif %}>7 ุณููุงุช</option>
          <option value="8" {% if request.POST.age == "8" %}selected{% endif %}>8 ุณููุงุช</option>
          <option value="9" {% if request.POST.age == "9" %}selected{% endif %}>9 ุณููุงุช</option>
          <option value="10" {% if request.POST.age == "10" %}selected{% endif %}>10 ุณููุงุช</option>
          <option value="11" {% if request.POST.age == "11" %}selected{% endif %}>11 ุณูุฉ</option>
          <option value="12" {% if request.POST.age == "12" %}selected{% endif %}>12 ุณูุฉ</option>
          <option value="13" {% if request.POST.age == "13" %}selected{% endif %}>13 ุณูุฉ</option>
          <option value="14" {% if request.POST.age == "14" %}selected{% endif %}>14 ุณูุฉ</option>
          <option value="15" {% if request.POST.age == "15" %}selected{% endif %}>15 ุณูุฉ</option>
        </select>
        <div class="age-preview" id="agePreview"></div>
      </div>

      <div class="form-group password-container">
        <label for="password">ูููุฉ ุงููุฑูุฑ</label>
        <input
          type="password"
          id="password"
          name="password"
          required
          placeholder="ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู"
          autocomplete="new-password"
        />
        <span class="toggle-password" id="togglePassword">๐๏ธ</span>
        <div class="error-message" id="passwordError">
          ูุฌุจ ุฃู ุชููู ูููุฉ ุงููุฑูุฑ 6 ุฃุญุฑู ุนูู ุงูุฃูู
        </div>
        <div class="password-strength" id="passwordStrength">
          <div class="password-strength-bar" id="passwordStrengthBar"></div>
        </div>
      </div>

      <div class="form-group password-container">
        <label for="password2">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ</label>
        <input
          type="password"
          id="password2"
          name="password2"
          required
          placeholder="ุฃุนุฏ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ"
          autocomplete="new-password"
        />
        <span class="toggle-password" id="togglePassword2">๐๏ธ</span>
        <div class="error-message" id="password2Error">
          ูููุชุง ุงููุฑูุฑ ุบูุฑ ูุชุทุงุจูุชูู
        </div>
      </div>

      <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

      <h3 style="margin-bottom: 15px; color: #333;">ูุนูููุงุช ููู ุงูุฃูุฑ (ุงุฎุชูุงุฑู)</h3>

      <div class="form-group">
        <label for="parent_name">ุงุณู ููู ุงูุฃูุฑ</label>
        <input
          type="text"
          id="parent_name"
          name="parent_name"
          placeholder="ุฃุฏุฎู ุงุณู ููู ุงูุฃูุฑ"
          value="{{ request.POST.parent_name|default:'' }}"
        />
      </div>

      <div class="form-group">
        <label for="parent_email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููู ุงูุฃูุฑ</label>
        <input
          type="email"
          id="parent_email"
          name="parent_email"
          placeholder="parent@example.com"
          value="{{ request.POST.parent_email|default:'' }}"
        />
      </div>

      <div class="form-group">
        <label for="parent_phone">ูุงุชู ููู ุงูุฃูุฑ</label>
        <input
          type="tel"
          id="parent_phone"
          name="parent_phone"
          placeholder="05xxxxxxxx"
          value="{{ request.POST.parent_phone|default:'' }}"
        />
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="is_parent" name="is_parent" {% if request.POST.is_parent %}checked{% endif %} />
        <label for="is_parent">
          ุฃูุง ููู ุฃูุฑ ูุฃุฑูุฏ ุฅูุดุงุก ุญุณุงุจ ูููุฑุงูุจุฉ
        </label>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="terms" name="terms" required />
        <label for="terms">
          ุฃูุงูู ุนูู
          <a href="#terms" class="terms-link">ุงูุดุฑูุท ูุงูุฃุญูุงู</a>
        </label>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        <span class="btn-text">ุฅูุดุงุก ุงูุญุณุงุจ</span>
        <span class="spinner"></span>
      </button>
    </form>

    <div class="login-link">
      ูุฏูู ุญุณุงุจ ุจุงููุนูุ
      <a href="{% url 'accounts:login' %}">ุชุณุฌูู ุงูุฏุฎูู</a>
    </div>
  </div>

  <div class="illustration-section">
    <div class="illustration-content">
      <div class="illustration-icon">๐๐ฐ</div>
      <div class="illustration-title">ุงุจุฏุฃ ุฑุญูุชู ุงููุงููุฉ!</div>
      <div class="illustration-desc">
        ุชุนูู ุฅุฏุงุฑุฉ ุงููุงู ุจุทุฑููุฉ ููุชุนุฉ ูุขููุฉ
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Toggle password visibility
  const togglePassword = document.getElementById("togglePassword");
  const togglePassword2 = document.getElementById("togglePassword2");
  const passwordInput = document.getElementById("password");
  const password2Input = document.getElementById("password2");

  togglePassword.addEventListener("click", () => {
    const type = passwordInput.type === "password" ? "text" : "password";
    passwordInput.type = type;
    togglePassword.textContent = type === "password" ? "๐๏ธ" : "๐";
  });

  togglePassword2.addEventListener("click", () => {
    const type = password2Input.type === "password" ? "text" : "password";
    password2Input.type = type;
    togglePassword2.textContent = type === "password" ? "๐๏ธ" : "๐";
  });

  // Form validation
  const signupForm = document.getElementById("signupForm");
  const usernameInput = document.getElementById("username");
  const emailInput = document.getElementById("email");
  const ageSelect = document.getElementById("age");
  const termsCheckbox = document.getElementById("terms");
  const submitBtn = document.getElementById("submitBtn");

  // Icons
  const usernameIcon = document.getElementById("usernameIcon");
  const emailIcon = document.getElementById("emailIcon");

  // Error messages
  const usernameError = document.getElementById("usernameError");
  const emailError = document.getElementById("emailError");
  const passwordError = document.getElementById("passwordError");
  const password2Error = document.getElementById("password2Error");

  // Age preview
  const agePreview = document.getElementById("agePreview");
  const ageMessages = {
    "5": "๐จ ูุญุชูู ููุงุฆู ููุฃุทูุงู ุงูุตุบุงุฑ ูุน ุฃูุนุงุจ ุชูุงุนููุฉ ุจุณูุทุฉ",
    "6": "๐จ ูุญุชูู ููุงุฆู ููุฃุทูุงู ุงูุตุบุงุฑ ูุน ุฃูุนุงุจ ุชูุงุนููุฉ ุจุณูุทุฉ",
    "7": "๐จ ูุญุชูู ููุงุฆู ููุฃุทูุงู ุงูุตุบุงุฑ ูุน ุฃูุนุงุจ ุชูุงุนููุฉ ุจุณูุทุฉ",
    "8": "๐ฎ ุฃูุดุทุฉ ูุชูุณุทุฉ ุงูุตุนูุจุฉ ูุน ุชุญุฏูุงุช ููุชุนุฉ",
    "9": "๐ฎ ุฃูุดุทุฉ ูุชูุณุทุฉ ุงูุตุนูุจุฉ ูุน ุชุญุฏูุงุช ููุชุนุฉ",
    "10": "๐ฎ ุฃูุดุทุฉ ูุชูุณุทุฉ ุงูุตุนูุจุฉ ูุน ุชุญุฏูุงุช ููุชุนุฉ",
    "11": "๐ ูุญุชูู ูุชูุฏู ูุน ููุงู ูุงูุนูุฉ ูุฅุฏุงุฑุฉ ุงููุงู",
    "12": "๐ ูุญุชูู ูุชูุฏู ูุน ููุงู ูุงูุนูุฉ ูุฅุฏุงุฑุฉ ุงููุงู",
    "13": "๐ ูุญุชูู ูุชูุฏู ูุน ููุงู ูุงูุนูุฉ ูุฅุฏุงุฑุฉ ุงููุงู",
    "14": "๐ ูุญุชูู ูุชูุฏู ูุน ููุงู ูุงูุนูุฉ ูุฅุฏุงุฑุฉ ุงููุงู",
    "15": "๐ ูุญุชูู ูุชูุฏู ูุน ููุงู ูุงูุนูุฉ ูุฅุฏุงุฑุฉ ุงููุงู"
  };

  ageSelect.addEventListener("change", () => {
    const value = ageSelect.value;
    if (value && ageMessages[value]) {
      agePreview.textContent = ageMessages[value];
      agePreview.classList.add("show");
    } else {
      agePreview.classList.remove("show");
    }
  });

  // Real-time username validation
  usernameInput.addEventListener("input", () => {
    const value = usernameInput.value.trim();
    if (value.length >= 3) {
      usernameInput.style.borderColor = "var(--success)";
      usernameIcon.textContent = "โ";
      usernameIcon.classList.add("success-icon");
      usernameIcon.classList.remove("error-icon");
      usernameError.classList.remove("show");
    } else if (value.length > 0) {
      usernameInput.style.borderColor = "var(--error)";
      usernameIcon.textContent = "โ";
      usernameIcon.classList.add("error-icon");
      usernameIcon.classList.remove("success-icon");
    } else {
      usernameInput.style.borderColor = "var(--border)";
      usernameIcon.textContent = "@";
      usernameIcon.classList.remove("success-icon", "error-icon");
    }
  });

  // Real-time email validation
  emailInput.addEventListener("input", () => {
    const value = emailInput.value.trim();
    if (validateEmail(value)) {
      emailInput.style.borderColor = "var(--success)";
      emailIcon.textContent = "โ";
      emailIcon.classList.add("success-icon");
      emailIcon.classList.remove("error-icon");
      emailError.classList.remove("show");
    } else if (value.length > 0) {
      emailInput.style.borderColor = "var(--error)";
      emailIcon.textContent = "โ";
      emailIcon.classList.add("error-icon");
      emailIcon.classList.remove("success-icon");
    } else {
      emailInput.style.borderColor = "var(--border)";
      emailIcon.textContent = "โ๏ธ";
      emailIcon.classList.remove("success-icon", "error-icon");
    }
  });

  // Password strength indicator
  const passwordStrength = document.getElementById("passwordStrength");
  const passwordStrengthBar = document.getElementById("passwordStrengthBar");

  passwordInput.addEventListener("input", () => {
    const value = passwordInput.value;

    if (value.length > 0) {
      passwordStrength.classList.add("show");

      let strength = 0;
      if (value.length >= 6) strength++;
      if (value.length >= 8) strength++;
      if (/[A-Z]/.test(value) || /[ุง-ู]/.test(value)) strength++;
      if (/[0-9]/.test(value)) strength++;
      if (/[^A-Za-z0-9ุง-ู]/.test(value)) strength++;

      passwordStrengthBar.className = "password-strength-bar";

      if (strength <= 2) {
        passwordStrengthBar.classList.add("weak");
      } else if (strength <= 3) {
        passwordStrengthBar.classList.add("medium");
      } else {
        passwordStrengthBar.classList.add("strong");
      }

      if (value.length >= 6) {
        passwordInput.style.borderColor = "var(--success)";
        passwordError.classList.remove("show");
      } else {
        passwordInput.style.borderColor = "var(--error)";
      }
    } else {
      passwordStrength.classList.remove("show");
      passwordInput.style.borderColor = "var(--border)";
    }

    // Check password match
    checkPasswordMatch();
  });

  // Check password match
  password2Input.addEventListener("input", checkPasswordMatch);

  function checkPasswordMatch() {
    const password = passwordInput.value;
    const password2 = password2Input.value;

    if (password2.length > 0) {
      if (password === password2) {
        password2Input.style.borderColor = "var(--success)";
        password2Error.classList.remove("show");
      } else {
        password2Input.style.borderColor = "var(--error)";
        password2Error.classList.add("show");
      }
    } else {
      password2Input.style.borderColor = "var(--border)";
      password2Error.classList.remove("show");
    }
  }

  // Email validation helper
  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // Progress bar update
  const progressSteps = document.querySelectorAll(".progress-step");

  function updateProgressBar(step) {
    progressSteps.forEach((stepEl, index) => {
      if (index < step) {
        stepEl.classList.add("active");
      } else {
        stepEl.classList.remove("active");
      }
    });
  }

  // Update progress based on form completion
  signupForm.addEventListener("input", () => {
    const username = usernameInput.value.trim();
    const email = emailInput.value.trim();
    const age = ageSelect.value;
    const password = passwordInput.value;
    const terms = termsCheckbox.checked;

    if (username && age) {
      updateProgressBar(2);
    } else if (username) {
      updateProgressBar(1);
    }

    if (username && age && email && password && terms) {
      updateProgressBar(3);
    }
  });

  // Form submission
  signupForm.addEventListener("submit", (e) => {
    const username = usernameInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const password2 = password2Input.value;
    const terms = termsCheckbox.checked;

    let isValid = true;

    // Validate username
    if (username.length < 3) {
      usernameError.classList.add("show");
      usernameInput.style.borderColor = "var(--error)";
      isValid = false;
    }

    // Validate email
    if (!validateEmail(email)) {
      emailError.classList.add("show");
      emailInput.style.borderColor = "var(--error)";
      isValid = false;
    }

    // Validate password
    if (password.length < 6) {
      passwordError.classList.add("show");
      passwordInput.style.borderColor = "var(--error)";
      isValid = false;
    }

    // Validate password match
    if (password !== password2) {
      password2Error.classList.add("show");
      password2Input.style.borderColor = "var(--error)";
      isValid = false;
    }

    // Validate terms
    if (!terms) {
      alert("ุงูุฑุฌุงุก ุงูููุงููุฉ ุนูู ุงูุดุฑูุท ูุงูุฃุญูุงู");
      isValid = false;
    }

    if (!isValid) {
      e.preventDefault();
      return;
    }

    // Add loading state
    submitBtn.classList.add("loading");
    submitBtn.disabled = true;
  });
</script>
{% endblock %}